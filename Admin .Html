<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Gaming Tournament</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Dark Theme Variables --- */
        :root {
            --primary-bg: #0F172A; /* Slate 900 */
            --secondary-bg: #1E293B; /* Slate 800 */
            --card-bg: #1E293B; /* Slate 800 */
            --sidebar-bg: #111827; /* Gray 900 */
            --text-primary: #E2E8F0; /* Slate 200 */
            --text-secondary: #94A3B8; /* Slate 400 */
            --text-muted-custom: #64748B; /* Slate 500 - Improved visibility for muted text */
            --accent-color: #FACC15; /* Yellow 500 */
            --accent-gradient: linear-gradient(to right, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6; /* Blue 500 */
            --border-color: #334155; /* Slate 700 */
            --success-color: #10B981; /* Emerald 500 */
            --danger-color: #EF4444; /* Red 500 */
            --warning-color: #F59E0B; /* Amber 500 */
            --info-color: #60A5FA; /* Blue 400 */
            --link-color: #9CA3AF; /* Gray 400 */
            --link-hover-color: #E5E7EB; /* Gray 200 */
            --placeholder-bg: rgba(100, 116, 139, 0.15); /* Slate 500 with opacity */
        }
        body { background-color: var(--primary-bg); color: var(--text-primary); font-family: 'Poppins', sans-serif; padding-top: 60px; }
        .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: var(--secondary-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 1030; border-bottom: 1px solid var(--border-color);}
        .header-left { display: flex; align-items: center; gap: 10px;}
        .menu-toggle-btn { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; padding: 0 5px; margin-left: -5px;}
        .header-logo { width: 35px; height: 35px; border-radius: 50%; background-color: #fff; object-fit: cover; border: 1px solid var(--accent-color);}
        .header-title { font-size: 1rem; font-weight: 600; line-height: 1.2;}
        .header-right { display: flex; align-items: center; gap: 15px;}
        .admin-email-header { font-size: 0.8rem; color: var(--text-secondary); display: none; }
        @media (min-width: 576px) { .admin-email-header { display: inline; } }
        .offcanvas-start { background-color: var(--sidebar-bg); color: var(--link-color); width: 260px !important; border-right: 1px solid var(--border-color);}
        .offcanvas-header { border-bottom: 1px solid var(--border-color); padding: 1rem 1.2rem;}
        .offcanvas-title h5 { color: var(--text-primary); margin-bottom: 0; font-size: 1.1rem; }
        .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%);}
        .offcanvas-body { padding: 0; display: flex; flex-direction: column; height: calc(100% - 56px); }
        .offcanvas-body .nav { flex-grow: 1; overflow-y: auto; }
        .offcanvas-body .nav-link { color: var(--link-color); padding: 0.8rem 1.2rem; border-left: 3px solid transparent; font-size: 0.95rem;}
        .offcanvas-body .nav-link.active, .offcanvas-body .nav-link:hover { color: var(--link-hover-color); background-color: rgba(255, 255, 255, 0.05); border-left-color: var(--accent-color);}
        .offcanvas-body .nav-link i { margin-right: 12px; width: 20px; text-align: center; font-size: 1.1rem;}
        .offcanvas-logout-btn { margin: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;}
        .main-content { padding: 20px; }
        .section { display: none; animation: fadeIn 0.5s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .section-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 20px; }
        .login-container { max-width: 400px; margin: 10vh auto; background-color: var(--secondary-bg); padding: 2rem; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.2);}
        #adminLoader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; display: none; }
        .spinner-border { color: var(--accent-color); }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); margin-bottom: 1.5rem; }
        .card-title { color: var(--text-primary); }
        .table-responsive { overflow-x: auto; }
        .table { background-color: var(--card-bg); color: var(--text-primary); border-color: var(--border-color); margin-bottom: 0;}
        .table > :not(caption) > * > * { background-color: transparent !important; border-bottom-color: var(--border-color); }
        .table th { color: var(--text-secondary); font-weight: 500; white-space: nowrap; padding: 0.8rem 1rem;}
        .table td { vertical-align: middle; white-space: nowrap; padding: 0.7rem 1rem;}
        .table td .text-muted { color: var(--text-muted-custom) !important; }
        .table td small.text-muted { font-size: 0.85em; }
        .table-hover > tbody > tr:hover > * { background-color: rgba(255, 255, 255, 0.03) !important; color: var(--text-primary); }
        .action-buttons button, .action-buttons a { margin-right: 5px; margin-bottom: 5px; }
        .modal-content { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .modal-header { border-bottom-color: var(--border-color); }
        .modal-footer { border-top-color: var(--border-color); }
        .modal-body label { margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        .form-control, .form-select { background-color: var(--primary-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .form-control:focus, .form-select:focus { background-color: var(--primary-bg); color: var(--text-primary); border-color: var(--accent-color); box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25); }
        .form-control::placeholder { color: var(--text-secondary); opacity: 0.7; }
        .form-control:disabled, .form-select:disabled { background-color: #2d3748; opacity: 0.7; }
        .form-control[type="file"] { background-color: var(--primary-bg); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .form-control[type="color"] { min-height: 38px; padding: 0.2rem; }
        .imgbb-upload-status, .video-upload-status { display: block; margin-top: 5px; font-size: 0.85rem; color: var(--text-secondary);}
        .table img.preview-img { max-width: 60px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 1px solid var(--border-color); }
        .text-bg-primary { background-color: #3B82F6 !important; }
        .text-bg-info { background-color: #0ea5e9 !important; }
        .text-bg-warning { background-color: #f59e0b !important; }
        .text-bg-success { background-color: #10b981 !important; }
        .text-bg-danger { background-color: #ef4444 !important; }
        .text-bg-secondary { background-color: #6b7280 !important; }
        .text-bg-dark { background-color: #374151 !important; }
        .nav-tabs .nav-link { color: var(--text-secondary); border-color: var(--border-color); border-bottom-color: transparent; margin-bottom: -1px;}
        .nav-tabs .nav-link.active { color: var(--accent-color); background-color: var(--card-bg); border-color: var(--border-color); border-bottom-color: var(--card-bg); font-weight: 600; }
        .nav-tabs { border-bottom-color: var(--border-color); }
        .textarea.form-control { min-height: 120px; }
        .copy-btn { cursor: pointer; opacity: 0.6; transition: opacity 0.2s; }
        .copy-btn:hover { opacity: 1; }
        .status-badge { font-size: 0.8em; padding: 0.3em 0.6em; border-radius: 0.25rem; }
        .loading-placeholder td > div { background-color: var(--placeholder-bg); border-radius: 4px; min-height: 1.2em; animation: placeholder-glow 2s ease-in-out infinite; }
        @keyframes placeholder-glow { 0% { background-color: var(--placeholder-bg); } 50% { background-color: rgba(100, 116, 139, 0.2); } 100% { background-color: var(--placeholder-bg); } }
        .dash-card-icon { font-size: 1.8rem; opacity: 0.6; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); }
        .card-body { position: relative; }
        .color-picker-group { display: flex; align-items: center; gap: 10px; }
        .color-picker-group label { flex-shrink: 0; width: 140px; }
        .color-picker-group .form-control[type="color"] { width: 50px; flex-shrink: 0; }
        .color-picker-group .form-control[type="text"] { flex-grow: 1; }
        .table .wrap-text { white-space: normal; word-break: break-word; min-width: 250px; }
        .tag-badge { display: inline-block; padding: .35em .65em; font-size: .75em; font-weight: 700; line-height: 1; color: #fff; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: .25rem; background-color: #334155; margin: 2px; }
        .rating-stars { color: var(--warning-color); }
        
        /* Season & Episode specific styles */
        .season-item .card-header { padding: 0.5rem 1rem; background-color: rgba(0,0,0,0.2); }
        .season-item .card-body { padding: 1rem; }
        .episode-item {
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .episode-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        #seasons-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        /* Comment & Reply Styles */
        .comment-reply-row > td {
            border-top: 1px dashed rgba(255,255,255,0.1) !important;
            padding-left: 2.5rem !important; /* Indentation */
        }
        .comment-reply-row {
            background-color: rgba(0, 0, 0, 0.1) !important;
        }
        tr.table-info > td, .comment-reply-row.table-info > td {
             background-color: rgba(var(--bs-info-rgb), 0.1) !important;
             --bs-table-accent-bg: transparent !important;
        }
        .accordion-button { background-color: var(--secondary-bg); color: var(--text-primary); }
        .accordion-button:not(.collapsed) { background-color: var(--primary-button-bg); color: white; }
        .accordion-button:focus { box-shadow: 0 0 0 0.25rem rgba(var(--bs-info-rgb), 0.5);}
        .accordion-body { background-color: var(--primary-bg); }
        .accordion-item { border-color: var(--border-color); }
    </style>
</head>
<body>

    <div id="adminLoader">
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <!-- Login / Setup Area -->
    <div id="auth-container">
        <div id="admin-setup-section" style="display: none;">
            <div class="container login-container"> <div class="card shadow"> <div class="card-body p-4"> <h2 class="card-title text-center mb-4">Admin Account Setup</h2> <p class="text-muted text-center small mb-3">Create the primary admin account.</p> <form id="adminSetupForm"> <div class="mb-3"> <label for="setupEmail" class="form-label">Admin Email</label> <input type="email" class="form-control" id="setupEmail" required> </div> <div class="mb-3"> <label for="setupPassword" class="form-label">Admin Password (min 6 chars)</label> <input type="password" class="form-control" id="setupPassword" required minlength="6"> </div> <div id="adminSetupStatus" class="mt-3"></div> <div class="d-grid"> <button type="submit" class="btn btn-success">Create Admin Account</button> </div> </form> </div> </div> </div>
        </div>
        <div id="admin-login-section" style="display: none;">
            <div class="container login-container"> <div class="card shadow"> <div class="card-body p-4"> <h2 class="card-title text-center mb-4">Admin Login</h2> <form id="adminLoginForm"> <div class="mb-3"> <label for="adminEmail" class="form-label">Email</label> <input type="email" class="form-control" id="adminEmail" required> </div> <div class="mb-3"> <label for="adminPassword" class="form-label">Password</label> <input type="password" class="form-control" id="adminPassword" required> </div> <div id="adminLoginStatus" class="mt-3"></div> <div class="d-grid"> <button type="submit" class="btn btn-primary">Login</button> </div> </form> </div> </div> </div>
        </div>
    </div>

    <!-- Main Admin Panel Area -->
    <div id="admin-main-area" style="display: none;">
        <header class="app-header">
            <div class="header-left">
                <button class="menu-toggle-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#adminSidebar" aria-controls="adminSidebar">
                    <i class="bi bi-list"></i>
                </button>
                <img src="https://via.placeholder.com/35/1E293B/94A3B8?text=L" alt="Logo" class="header-logo" id="adminHeaderLogo" style="display:none;">
                <h1 class="header-title ms-1" id="adminPageTitle">Dashboard</h1>
            </div>
            <div class="header-right">
                <span class="admin-email-header" id="adminUserEmailShort"></span>
                <button class="btn btn-sm btn-outline-danger" id="adminLogoutBtnHeader"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </div>
        </header>

        <div class="offcanvas offcanvas-start" tabindex="-1" id="adminSidebar" aria-labelledby="adminSidebarLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="adminSidebarLabel">Admin Menu</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="nav flex-column">
                     <li class="nav-item"> <a class="nav-link active" href="#" data-section="dashboard-section"><i class="bi bi-speedometer2"></i> Dashboard</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="games-section"><i class="bi bi-controller"></i> Games</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="movies-section"><i class="bi bi-film"></i> Movies</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="movie-categories-section"><i class="bi bi-tags-fill"></i> Movie Categories</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="movie-reviews-section"><i class="bi bi-chat-left-text-fill"></i> Movie Comments</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="promotions-section"><i class="bi bi-images"></i> App Promotions</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="movie-promotions-section"><i class="bi bi-camera-reels"></i> Movie Promotions</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="tournaments-section"><i class="bi bi-trophy"></i> Tournaments</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="users-section"><i class="bi bi-people"></i> Users</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="leaderboard-section"><i class="bi bi-bar-chart-line-fill"></i> Leaderboard</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="notifications-section"><i class="bi bi-bell-fill"></i> Notifications</a> </li>
                     <li class="nav-item"> <a class="nav-link" href="#" data-section="transactions-section"><i class="bi bi-receipt"></i> Transactions</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="withdrawals-section"><i class="bi bi-cash-coin"></i> Withdrawals <span class="badge bg-danger ms-1" id="pendingWithdrawalCountBadge" style="display: none;">0</span></a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="settings-section"><i class="bi bi-gear"></i> Settings</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="theme-section"><i class="bi bi-palette-fill"></i> Theme</a> </li>
                </ul>
                <div class="mt-auto p-3 border-top border-secondary">
                     <button class="btn btn-warning btn-sm w-100 mb-2" id="addDemoDataBtn"><i class="bi bi-database-add"></i> Add Demo Data</button>
                     <small class="text-muted d-block text-center">Adds sample data if DB is empty.</small>
                </div>
            </div>
        </div>

        <main class="main-content" id="adminMainContent">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="section active">
                <h2>Dashboard Overview</h2>
                <div class="row">
                    <!-- Row 1 -->
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-primary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Users</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalUsers">--</p>
                                <i class="bi bi-people-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-info shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Active/Upcoming Tournaments</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statActiveTournaments">--</p>
                                <i class="bi bi-trophy-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-warning shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Pending Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statPendingWithdrawals">--</p>
                                <i class="bi bi-hourglass-split dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-success shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Completed Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statCompletedWithdrawals">--</p>
                                <i class="bi bi-check-circle-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <!-- Row 2 -->
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-dark shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Rejected Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statRejectedWithdrawals">--</p>
                                <i class="bi bi-x-octagon-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Games</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalGames">--</p>
                                <i class="bi bi-controller dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Movies</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalMovies">--</p>
                                <i class="bi bi-film dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Comments</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalReviews">--</p>
                                <i class="bi bi-chat-dots-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <!-- Row 3 -->
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">App Promotions</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalPromotions">--</p>
                                <i class="bi bi-images dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Movie Promotions</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalMoviePromotions">--</p>
                                <i class="bi bi-camera-reels dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Finished Tournaments</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statFinishedTournaments">--</p>
                                <i class="bi bi-flag-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-danger shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Images</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalImages">--</p>
                                <i class="bi bi-card-image dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <!-- Row 4 -->
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-info shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Youtube</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalVideos">--</p>
                                <i class="bi bi-film dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-primary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Facebook</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalFacebookLinks">--</p>
                                <i class="bi bi-facebook dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-danger shadow-sm h-100" style="background-color: #d62976 !important;">
                             <div class="card-body">
                                 <h5 class="card-title">Total Instagram</h5>
                                 <p class="card-text fs-3 fw-bold mb-0" id="statTotalInstagramLinks">--</p>
                                 <i class="bi bi-instagram dash-card-icon"></i>
                             </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-dark shadow-sm h-100">
                             <div class="card-body">
                                 <h5 class="card-title">Total TikTok</h5>
                                 <p class="card-text fs-3 fw-bold mb-0" id="statTotalTiktokLinks">--</p>
                                 <i class="bi bi-tiktok dash-card-icon"></i>
                             </div>
                        </div>
                    </div>
                     <!-- Row 5 -->
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-info shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Notifications Sent</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalNotifications">--</p>
                                <i class="bi bi-bell-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-warning shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Top Earner</h5>
                                <p class="card-text fs-4 fw-bold mb-0" id="statTopEarner">--</p>
                                <i class="bi bi-award-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dashboardStatus"></div>
            </section>

            <!-- Games Section -->
            <section id="games-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Games</h2>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#gameModal" id="addNewGameBtn"><i class="bi bi-plus-circle"></i> Add Game</button>
                </div>
                 <div id="gamesStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead> <tr><th>Image</th><th>Name</th><th>Game ID</th><th>Actions</th></tr> </thead>
                        <tbody id="gamesTableBody">
                            <tr class="loading-placeholder"><td colspan="4"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Movies Section -->
            <section id="movies-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Movies</h2>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#movieModal" id="addNewMovieBtn"><i class="bi bi-plus-circle"></i> Add Movie</button>
                </div>
                 <div id="moviesStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead> <tr><th>Image</th><th>Name</th><th>Category</th><th>Access</th><th>Language</th><th>Rating</th><th>Seasons</th><th>Release Date</th><th>Tags</th><th>Actions</th></tr> </thead>
                        <tbody id="moviesTableBody">
                            <tr class="loading-placeholder"><td colspan="10"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Movie Categories Section -->
            <section id="movie-categories-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Movie Categories</h2>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#movieCategoryModal" id="addNewMovieCategoryBtn"><i class="bi bi-plus-circle"></i> Add Category</button>
                </div>
                 <div id="movieCategoriesStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead> <tr><th>Image</th><th>Category Name</th><th>Actions</th></tr> </thead>
                        <tbody id="movieCategoriesTableBody">
                            <tr class="loading-placeholder"><td colspan="3"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Movie Reviews Section -->
            <section id="movie-reviews-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Movie Comments</h2>
                </div>
                 <div id="movieReviewsStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead> <tr><th>Movie & Episode</th><th>User</th><th class="wrap-text">Comment</th><th>Rating</th><th>Date</th><th>Actions</th></tr> </thead>
                        <tbody id="movieReviewsTableBody">
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- App Promotions Section -->
            <section id="promotions-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage App Promotions</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#promotionModal" id="addNewPromotionBtn"><i class="bi bi-plus-circle"></i> Add Promotion</button>
                </div>
                <div id="promotionsStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                         <thead> <tr><th>Image</th><th>Link</th><th>Actions</th></tr> </thead>
                         <tbody id="promotionsTableBody">
                            <tr class="loading-placeholder"><td colspan="3"><div class="placeholder w-100 py-3"></div></td></tr>
                         </tbody>
                    </table>
                </div>
            </section>

            <!-- Movie Promotions Section -->
            <section id="movie-promotions-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Movie Promotions</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#moviePromotionModal" id="addNewMoviePromotionBtn"><i class="bi bi-plus-circle"></i> Add Movie Promotion</button>
                </div>
                <div id="moviePromotionsStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                         <thead> <tr><th>Image</th><th>Link</th><th>Actions</th></tr> </thead>
                         <tbody id="moviePromotionsTableBody">
                            <tr class="loading-placeholder"><td colspan="3"><div class="placeholder w-100 py-3"></div></td></tr>
                         </tbody>
                    </table>
                </div>
            </section>

            <!-- Tournaments Section -->
            <section id="tournaments-section" class="section">
                 <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Tournaments</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addTournamentModal" id="addNewTournamentBtn"><i class="bi bi-plus-circle"></i> Add Tournament</button>
                 </div>
                 <div id="tournamentsStatus" class="mb-3"></div>
                 <div class="table-responsive card">
                     <table class="table table-dark table-hover mb-0">
                         <thead> <tr><th>Image</th><th>Name</th><th>Game</th><th>Fee</th><th>Prize</th><th>Start Time</th><th>Status</th><th>Players</th><th>Video</th><th>Facebook</th><th>Instagram</th><th>TikTok</th><th>Actions</th></tr> </thead>
                         <tbody id="tournamentsTableBody">
                            <tr class="loading-placeholder"><td colspan="13"><div class="placeholder w-100 py-3"></div></td></tr>
                         </tbody>
                    </table>
                 </div>
            </section>

            <!-- Users Section -->
            <section id="users-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Users</h2>
                    <div class="d-flex gap-2">
                        <input type="search" class="form-control form-control-sm" id="userSearchInput" placeholder="Search by name or email...">
                        <button class="btn btn-success btn-sm flex-shrink-0" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="bi bi-person-plus-fill"></i> Add User
                        </button>
                    </div>
                </div>
                 <div id="usersStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr><th>UID</th><th>Display Name</th><th>Email</th><th>Balance</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- ======================= -->
            <!-- LEADERBOARD SECTION -->
            <!-- ======================= -->
            <section id="leaderboard-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Leaderboard</h2>
                </div>
                <div id="leaderboardStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>User</th>
                                <th>Total Winnings</th>
                                <th>Matches Played</th>
                                <th>Win Rate</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardTableBody">
                            <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Notifications Section -->
            <section id="notifications-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Notifications</h2>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#notificationModal" id="sendNewNotificationBtn">
                        <i class="bi bi-send-plus"></i> Send New Notification
                    </button>
                </div>
                <div id="notificationsStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Sent At</th>
                                <th>Title</th>
                                <th>Message</th>
                                <th>Audience</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="notificationsTableBody">
                            <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Transactions Section -->
            <section id="transactions-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>All Transactions</h2>
                    <div class="d-flex gap-2">
                        <input type="search" class="form-control form-control-sm" id="transactionSearchInput" placeholder="Search by user, type, or desc...">
                    </div>
                </div>
                 <div id="transactionsStatus" class="mb-3"></div>
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Balance After</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Withdrawals Section -->
            <section id="withdrawals-section" class="section">
                <h2>Manage Withdrawals</h2>
                 <div id="withdrawalsStatus" class="mb-3"></div>
                <div class="card">
                    <div class="card-header bg-secondary border-bottom border-dark"> <ul class="nav nav-tabs card-header-tabs" id="withdrawalTabs" role="tablist"> <li class="nav-item" role="presentation"><button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pendingWithdrawalsTab" type="button" role="tab">Pending</button></li> <li class="nav-item" role="presentation"><button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completedWithdrawalsTab" type="button" role="tab">Completed</button></li> <li class="nav-item" role="presentation"><button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejectedWithdrawalsTab" type="button" role="tab">Rejected</button></li> </ul> </div>
                    <div class="card-body tab-content p-0">
                        <div class="tab-pane fade show active" id="pendingWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>User</th><th>Amount</th><th>Method</th><th>Actions</th></tr></thead>
                                    <tbody id="pendingWithdrawalsTableBody"> <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr> </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="completedWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Method</th><th>Admin Note</th></tr></thead>
                                    <tbody id="completedWithdrawalsTableBody"> <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr> </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="rejectedWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Method</th><th>Reason</th></tr></thead>
                                    <tbody id="rejectedWithdrawalsTableBody"> <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                 </div>
            </section>
 
       <!-- Settings Section -->
            <section id="settings-section" class="section">
                <div class="card mb-4">
                    <div class="card-body">
                        <h2 class="card-title">App Settings</h2>
                        <form id="appSettingsForm">
                            <div class="row">
                                <div class="col-md-6 mb-3"> <label for="settingLogoUrl" class="form-label">Logo URL</label> <input type="url" class="form-control" id="settingLogoUrl"> </div>
                                <div class="col-md-6 mb-3"> <label for="settingAppName" class="form-label">App Name</label> <input type="text" class="form-control" id="settingAppName"> </div>
                                <div class="col-md-6 mb-3"> <label for="settingMinWithdraw" class="form-label">Min Withdraw (₹)</label> <input type="number" class="form-control" id="settingMinWithdraw" min="0" step="any"> </div>
                                <div class="col-md-6 mb-3"> <label for="settingReferralBonus" class="form-label">Referral Bonus (₹)</label> <input type="number" class="form-control" id="settingReferralBonus" min="0" step="any"> </div>
                                <div class="col-12 mb-3"> <label for="settingSupportContact" class="form-label">Admin Support Contact</label> <input type="text" class="form-control" id="settingSupportContact"> </div>
                                <div class="col-12 mb-3"> <label for="settingUpiDetails" class="form-label">UPI Details for Payment</label> <input type="text" class="form-control" id="settingUpiDetails"> </div>
                                <div class="col-12 mb-3"> <label for="settingPolicyPrivacy" class="form-label">Privacy Policy</label> <textarea class="form-control" id="settingPolicyPrivacy" rows="5"></textarea> </div>
                                <div class="col-12 mb-3"> <label for="settingPolicyTerms" class="form-label">Terms & Conditions</label> <textarea class="form-control" id="settingPolicyTerms" rows="5"></textarea> </div>
                                <div class="col-12 mb-3"> <label for="settingPolicyRefund" class="form-label">Refund Policy</label> <textarea class="form-control" id="settingPolicyRefund" rows="5"></textarea> </div>
                                <div class="col-12 mb-3"> <label for="settingPolicyFairPlay" class="form-label">Fair Play Policy</label> <textarea class="form-control" id="settingPolicyFairPlay" rows="5"></textarea> </div>
                            </div>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save Settings</button>
                            <div id="settingsStatus" class="mt-3"></div>
                        </form>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title">Change Admin Password</h2>
                        <form id="changePasswordForm">
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">Current Password</label>
                                <input type="password" class="form-control" id="currentPassword" required>
                            </div>
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">New Password (min 6 chars)</label>
                                <input type="password" class="form-control" id="newPassword" required minlength="6">
                            </div>
                            <div class="mb-3">
                                <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                                <input type="password" class="form-control" id="confirmNewPassword" required>
                            </div>
                            <button type="submit" class="btn btn-warning"><i class="bi bi-key-fill"></i> Change Password</button>
                            <div id="changePasswordStatus" class="mt-3"></div>
                        </form>
                    </div>
                </div>
            </section>
            
            <!-- Theme Section -->
            <section id="theme-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="section-title mb-0">Theme Customization</h2>
                    <button class="btn btn-danger btn-sm" id="resetThemeBtn"><i class="bi bi-arrow-counterclockwise"></i> Reset to Default Theme</button>
                </div>
                <div id="themeStatus" class="mb-3"></div>

                <div class="row">
                    <!-- Predefined Themes -->
                    <div class="col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Predefined Themes</h5>
                                <p class="card-text text-secondary small">Select a theme to preview the colors in the form below, then click "Save Theme" to apply it.</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-secondary" id="previewDefaultThemeBtn">Default Dark</button>
                                    <button class="btn btn-outline-danger" id="previewCrimsonThemeBtn">Crimson Dark</button>
                                    <button class="btn btn-outline-info" id="previewOceanicThemeBtn">Oceanic Blue</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Custom Theme Form -->
                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Custom Theme Colors</h5>
                                <form id="customThemeForm">
                                    <div class="row g-3">
                                        <!-- Key Colors -->
                                        <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-primary-bg" class="form-label">Primary BG</label>
                                                <input type="color" class="form-control form-control-color" id="theme-primary-bg" data-var="--primary-bg">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-primary-bg">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-accent-color" class="form-label">Accent Color</label>
                                                <input type="color" class="form-control form-control-color" id="theme-accent-color" data-var="--accent-color">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-accent-color">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-text-primary" class="form-label">Primary Text</label>
                                                <input type="color" class="form-control form-control-color" id="theme-text-primary" data-var="--text-primary">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-text-primary">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-primary-button-bg" class="form-label">Primary Button</label>
                                                <input type="color" class="form-control form-control-color" id="theme-primary-button-bg" data-var="--primary-button-bg">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-primary-button-bg">
                                            </div>
                                        </div>
                                        <div class="col-12"><hr class="my-2"></div>
                                        <!-- Other Colors -->
                                        <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-secondary-bg" class="form-label">Secondary BG</label>
                                                <input type="color" class="form-control form-control-color" id="theme-secondary-bg" data-var="--secondary-bg">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-secondary-bg">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-card-bg" class="form-label">Card BG</label>
                                                <input type="color" class="form-control form-control-color" id="theme-card-bg" data-var="--card-bg">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-card-bg">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-text-secondary" class="form-label">Secondary Text</label>
                                                <input type="color" class="form-control form-control-color" id="theme-text-secondary" data-var="--text-secondary">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-text-secondary">
                                            </div>
                                        </div>
                                         <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-border-color" class="form-label">Border Color</label>
                                                <input type="color" class="form-control form-control-color" id="theme-border-color" data-var="--border-color">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-border-color">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end mt-4">
                                         <button type="button" class="btn btn-primary" id="saveThemeBtn"><i class="bi bi-save"></i> Save Theme</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Modals -->
    <!-- Add/Edit Game Modal -->
    <div class="modal fade" id="gameModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="gameModalTitle">Add New Game</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="gameForm"> <input type="hidden" id="gameEditId"> <div class="mb-3"> <label for="gameName" class="form-label">Game Name</label> <input type="text" class="form-control" id="gameName" required> </div> <div class="mb-3"> <label for="gameImageUrl" class="form-label">Image URL</label> <input type="url" class="form-control" id="gameImageUrl" required> <small class="text-muted">Direct image URL (e.g., from ImgBB).</small> </div> <div class="mb-3"> <label for="gameImageFile" class="form-label">Upload New Image (Optional - Overwrites URL)</label> <input class="form-control" type="file" id="gameImageFile" accept="image/*"> <div class="imgbb-upload-status mt-2"></div> </div> <div id="gameStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="saveGameBtn">Save Game</button> </div> </div> </div> </div>

    <!-- Add/Edit Movie Modal -->
    <div class="modal fade" id="movieModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="movieModalTitle">Add New Movie</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="movieForm">
                        <input type="hidden" id="movieEditId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="movieName" class="form-label">Movie Name</label>
                                <input type="text" class="form-control" id="movieName" required>
                            </div>
                             <div class="col-md-6 mb-3">
                                <label for="movieImageUrl" class="form-label">Image URL (Photo URL)</label>
                                <input type="url" class="form-control" id="movieImageUrl" required>
                            </div>
                            <!-- NEW: Access Field -->
                            <div class="col-md-6 mb-3">
                                <label for="movieAccess" class="form-label">Access</label>
                                <select class="form-select" id="movieAccess" required>
                                    <option value="Free" selected>Free</option>
                                    <option value="Premium">Premium</option>
                                    <option value="VPN">VPN Required</option>
                                </select>
                            </div>
                            <!-- NEW: Language Field -->
                            <div class="col-md-6 mb-3">
                                <label for="movieLanguage" class="form-label">Language</label>
                                <input type="text" class="form-control" id="movieLanguage" placeholder="e.g., English, Hindi">
                            </div>
                             <!-- NEW: Rating Field -->
                            <div class="col-md-6 mb-3">
                                <label for="movieRating" class="form-label">Rating (out of 10)</label>
                                <input type="number" class="form-control" id="movieRating" min="0" max="10" step="0.1" placeholder="e.g., 8.5">
                            </div>
                             <div class="col-md-6 mb-3">
                                <label for="movieReleaseDate" class="form-label">Release Date (Year)</label>
                                <input type="date" class="form-control" id="movieReleaseDate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="movieCategoryId" class="form-label">Category</label>
                                <select class="form-select" id="movieCategoryId" required>
                                    <option value="">-- Select Category --</option>
                                </select>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="movieStory" class="form-label">Story / Synopsis</label>
                                <textarea class="form-control" id="movieStory" rows="4"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="movieTrailerName" class="form-label">Trailer Name</label>
                                <input type="text" class="form-control" id="movieTrailerName">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="movieTrailerUrl" class="form-label">Trailer URL</label>
                                <input type="url" class="form-control" id="movieTrailerUrl">
                            </div>
                             <div class="col-md-12 mb-3">
                                <label for="movieTags" class="form-label">Tags (comma-separated)</label>
                                <input type="text" class="form-control" id="movieTags" placeholder="e.g., Action, Sci-Fi, Thriller">
                            </div>
                        </div>

                        <hr>
                        <!-- Seasons & Episodes Section -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Seasons & Episodes</h6>
                            <button type="button" class="btn btn-sm btn-outline-info" id="addSeasonBtn"><i class="bi bi-plus-circle"></i> Add Season</button>
                        </div>
                        <div id="seasons-container">
                            <!-- Season & Episode items will be injected here by JavaScript -->
                        </div>

                        <div id="movieStatus" class="mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveMovieBtn">Save Movie</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Movie Category Modal -->
    <div class="modal fade" id="movieCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="movieCategoryModalTitle">Add New Movie Category</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="movieCategoryForm">
                        <input type="hidden" id="movieCategoryEditId">
                        <div class="mb-3">
                            <label for="movieCategoryName" class="form-label">Category Name</label>
                            <input type="text" class="form-control" id="movieCategoryName" required>
                        </div>
                        <div class="mb-3">
                            <label for="movieCategoryImageUrl" class="form-label">Image URL</label>
                            <input type="url" class="form-control" id="movieCategoryImageUrl" required>
                            <small class="text-muted">Direct image URL (e.g., from ImgBB).</small>
                        </div>
                        <div class="mb-3">
                            <label for="movieCategoryImageFile" class="form-label">Upload New Image (Optional - Overwrites URL)</label>
                            <input class="form-control" type="file" id="movieCategoryImageFile" accept="image/*">
                            <div class="imgbb-upload-status mt-2"></div>
                        </div>
                        <div id="movieCategoryStatus" class="mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveMovieCategoryBtn">Save Category</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reply to Comment Modal -->
    <div class="modal fade" id="replyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reply to Comment</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="replyForm">
                        <input type="hidden" id="replyMovieId">
                        <input type="hidden" id="replyEpisodeId">
                        <input type="hidden" id="replyCommentId">
                        <div class="mb-3">
                            <label class="form-label text-secondary">Replying to:</label>
                            <blockquote class="blockquote bg-dark p-2 rounded small" id="parentCommentText"></blockquote>
                        </div>
                        <div class="mb-3">
                            <label for="replyText" class="form-label">Your Reply (as Admin)</label>
                            <textarea class="form-control" id="replyText" rows="4" required></textarea>
                        </div>
                        <div id="replyStatus" class="mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveReplyBtn">Save Reply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit App Promotion Modal -->
    <div class="modal fade" id="promotionModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="promotionModalTitle">Add New App Promotion</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="promotionForm"> <input type="hidden" id="promotionEditId"> <div class="mb-3"> <label for="promoImageUrl" class="form-label">Image URL</label> <input type="url" class="form-control" id="promoImageUrl" required> <small class="text-muted">Direct image URL (e.g., from ImgBB).</small> </div> <div class="mb-3"> <label for="promoImageFile" class="form-label">Upload New Image (Optional - Overwrites URL)</label> <input class="form-control" type="file" id="promoImageFile" accept="image/*"> <div class="imgbb-upload-status mt-2"></div> </div> <div class="mb-3"> <label for="promoLink" class="form-label">Link (Optional)</label> <input type="url" class="form-control" id="promoLink"> </div> <div id="promotionStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="savePromotionBtn">Save Promotion</button> </div> </div> </div> </div>
   
    <!-- Add/Edit Movie Promotion Modal -->
    <div class="modal fade" id="moviePromotionModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="moviePromotionModalTitle">Add New Movie Promotion</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="moviePromotionForm"> <input type="hidden" id="moviePromotionEditId"> <div class="mb-3"> <label for="moviePromoImageUrl" class="form-label">Image URL</label> <input type="url" class="form-control" id="moviePromoImageUrl" required> <small class="text-muted">Direct image URL (e.g., from ImgBB).</small> </div> <div class="mb-3"> <label for="moviePromoImageFile" class="form-label">Upload New Image (Optional - Overwrites URL)</label> <input class="form-control" type="file" id="moviePromoImageFile" accept="image/*"> <div class="imgbb-upload-status mt-2"></div> </div> <div class="mb-3"> <label for="moviePromoLink" class="form-label">Link (Optional)</label> <input type="url" class="form-control" id="moviePromoLink"> </div> <div id="moviePromotionStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="saveMoviePromotionBtn">Save Movie Promotion</button> </div> </div> </div> </div>

    <!-- Add/Edit Tournament Modal -->
    <div class="modal fade" id="addTournamentModal" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="tournamentModalTitle">Add New Tournament</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="tournamentForm"> <input type="hidden" id="tournamentEditId"> <div class="row"> <div class="col-md-6 mb-3"> <label for="tournamentGame" class="form-label">Game</label> <select class="form-select" id="tournamentGame" required></select> </div> <div class="col-md-6 mb-3"> <label for="tournamentName" class="form-label">Tournament Name</label> <input type="text" class="form-control" id="tournamentName" required> </div>
                <div class="col-md-6 mb-3">
                    <label for="tournamentStartTime" class="form-label">Start Date & Time</label>
                    <input type="datetime-local" class="form-control" id="tournamentStartTime" required>
                    <div class="btn-group btn-group-sm w-100 mt-2" role="group">
                        <button type="button" class="btn btn-outline-secondary" data-time-adjust="now">Now</button>
                        <button type="button" class="btn btn-outline-info" data-time-adjust="add" data-unit="hours" data-amount="1">+1h</button>
                        <button type="button" class="btn btn-outline-info" data-time-adjust="add" data-unit="hours" data-amount="6">+6h</button>
                        <button type="button" class="btn btn-outline-info" data-time-adjust="add" data-unit="days" data-amount="1">+1d</button>
                        <button type="button" class="btn btn-outline-info" data-time-adjust="add" data-unit="weeks" data-amount="1">+1w</button>
                    </div>
                </div>
                <div class="col-md-6 mb-3"> <label for="tournamentStatus" class="form-label">Status</label> <select class="form-select" id="tournamentStatus" required> <option value="upcoming">Upcoming</option> <option value="ongoing">Ongoing</option> <option value="completed">Completed</option> <option value="result">Result</option> <option value="cancelled">Cancelled</option> </select> </div> <div class="col-md-4 mb-3"> <label for="tournamentEntryFee" class="form-label">Entry Fee (₹)</label> <input type="number" class="form-control" id="tournamentEntryFee" min="0" value="0" required step="any"> </div> <div class="col-md-4 mb-3"> <label for="tournamentPrizePool" class="form-label">Total Prize Pool (₹)</label> <input type="number" class="form-control" id="tournamentPrizePool" min="0" value="0" step="any"> </div> <div class="col-md-4 mb-3"> <label for="tournamentPerKill" class="form-label">Per Kill Prize (₹)</label> <input type="number" class="form-control" id="tournamentPerKill" min="0" value="0" step="any"> </div> <div class="col-md-6 mb-3"> <label for="tournamentMaxPlayers" class="form-label">Max Players (0 for Unlimited)</label> <input type="number" class="form-control" id="tournamentMaxPlayers" min="0" value="0" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentTags" class="form-label">Tags (comma-separated)</label> <input type="text" class="form-control" id="tournamentTags" placeholder="e.g., Solo, Erangel, TPP"> </div> 
                <div class="col-md-6 mb-3"> <label for="tournamentImageUrl" class="form-label">Tournament Image URL</label> <input type="url" class="form-control" id="tournamentImageUrl" placeholder="https://example.com/image.png"> </div> 
                <div class="col-md-6 mb-3"> <label for="tournamentVideoUrl" class="form-label">Video URL (Optional)</label> <input type="url" class="form-control" id="tournamentVideoUrl" placeholder="https://youtube.com/..."> </div> 
                <div class="col-md-4 mb-3"> <label for="tournamentFacebookUrl" class="form-label">Facebook URL (Optional)</label> <input type="url" class="form-control" id="tournamentFacebookUrl" placeholder="https://facebook.com/..."> </div> 
                <div class="col-md-4 mb-3"> <label for="tournamentInstagramUrl" class="form-label">Instagram URL (Optional)</label> <input type="url" class="form-control" id="tournamentInstagramUrl" placeholder="https://instagram.com/..."> </div>
                <div class="col-md-4 mb-3"> <label for="tournamentTiktokUrl" class="form-label">TikTok URL (Optional)</label> <input type="url" class="form-control" id="tournamentTiktokUrl" placeholder="https://tiktok.com/@..."> </div>
                <div class="col-12 mb-3"> <label for="tournamentDescription" class="form-label">Description / Rules</label> <textarea class="form-control" id="tournamentDescription" rows="4"></textarea> </div> <div class="col-md-6 mb-3"> <label for="tournamentRoomId" class="form-label">Room ID</label> <input type="text" class="form-control" id="tournamentRoomId"> </div> <div class="col-md-6 mb-3"> <label for="tournamentRoomPassword" class="form-label">Room Password</label> <input type="text" class="form-control" id="tournamentRoomPassword"> </div> <div class="form-check mb-3 ms-2"> <input class="form-check-input" type="checkbox" id="tournamentShowIdPass"> <label class="form-check-label" for="tournamentShowIdPass"> Show ID/Pass?</label> </div> </div> <div id="addTournamentStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="submit" class="btn btn-primary" id="saveTournamentBtn" form="tournamentForm">Save Tournament</button> </div> </div> </div> </div>
    <!-- View/Edit User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="userModalTitle">User Details</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <div class="row"> <div class="col-md-6"> <h5>User Info</h5> <p><strong>UID:</strong> <small id="userDetailUid" class="text-muted user-uid-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#userDetailUid" title="Copy UID"></i></p> <p><strong>Email:</strong> <span id="userDetailEmail"></span></p> <p><strong>Name:</strong> <span id="userDetailName"></span></p> <p><strong>Created At:</strong> <span id="userDetailCreatedAt">N/A</span></p> <hr> <h5>Wallet</h5> <p>Total Balance: ₹<span id="userDetailBalance">0.00</span></p> <p>Winning Cash: ₹<span id="userDetailWinning">0.00</span></p> <p>Bonus Cash: ₹<span id="userDetailBonus">0.00</span></p> <hr> <h5>Referral Info</h5> <p><strong>Referral Code:</strong> <span id="userDetailReferralCode" class="text-info">N/A</span> <i class="bi bi-clipboard copy-btn ms-1" data-target="#userDetailReferralCode" title="Copy Code"></i></p> <p><strong>Referred By:</strong> <span id="userDetailReferredBy">N/A</span></p> <p><strong>Users Referred:</strong> <span id="userDetailReferredCount">N/A</span></p> </div> <div class="col-md-6"> <h5>Update Balance (Caution!)</h5> <form id="updateBalanceForm"> <input type="hidden" id="editUserUid"> <div class="row"> <div class="col-md-6 mb-3"> <label for="balanceUpdateAmount" class="form-label">Amount (+/-)</label> <input type="number" step="any" class="form-control" id="balanceUpdateAmount" placeholder="e.g., 50 or -20" required> </div> <div class="col-md-6 mb-3"> <label for="balanceUpdateType" class="form-label">Balance Type</label> <select id="balanceUpdateType" class="form-select" required> <option value="">--Select--</option> <option value="balance">Total Balance</option> <option value="winningCash">Winning Cash</option> <option value="bonusCash">Bonus Cash</option> </select> </div> </div> <div class="mb-3"> <label for="balanceUpdateReason" class="form-label">Reason</label> <input type="text" class="form-control" id="balanceUpdateReason" placeholder="Manual Deposit, Correction etc." required> </div> <button type="submit" class="btn btn-warning">Update Balance</button> <div id="balanceUpdateStatus" class="mt-2"></div> </form> <hr> <h5>Status & Actions</h5> <p>Current Status: <span id="userDetailStatus" class="fw-bold"></span></p> <button class="btn btn-sm mb-2" id="userBlockBtn"></button> <button class="btn btn-sm btn-danger mb-2" id="userDeleteBtn"><i class="bi bi-trash"></i> Delete User (DB Only)</button> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>
    <!-- Withdrawal Action Modal -->
    <div class="modal fade" id="withdrawalActionModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">Withdrawal Action</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <p><strong>Request ID:</strong> <small id="withdrawalDetailId" class="text-muted withdrawal-id-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#withdrawalDetailId" title="Copy Request ID"></i></p> <p><strong>User:</strong> <span id="withdrawalDetailUser"></span> (<small id="withdrawalDetailUserUid" class="text-muted withdrawal-user-uid-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#withdrawalDetailUserUid" title="Copy User UID"></i>)</p> <p><strong>Amount:</strong> ₹<span id="withdrawalDetailAmount"></span></p> <p><strong>Method:</strong> <span id="withdrawalDetailMethod"></span></p> <hr> <div id="withdrawalRejectReasonDiv" style="display: none;" class="mb-3"> <label for="withdrawalRejectReason" class="form-label">Reason for Rejection</label> <textarea class="form-control" id="withdrawalRejectReason" rows="3" required></textarea> </div> <div id="withdrawalApproveNoteDiv" style="display: none;" class="mb-3"> <label for="withdrawalApproveNote" class="form-label">Admin Note / Txn ID (Optional)</label> <input type="text" class="form-control" id="withdrawalApproveNote" placeholder="e.g., Transaction ID"> </div> <div id="withdrawalActionStatus" class="mt-2"></div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-danger" id="rejectWithdrawalBtn">Reject</button> <button type="button" class="btn btn-success" id="approveWithdrawalBtn">Approve</button> </div> </div> </div> </div>
    <!-- Add New User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label for="newUserName" class="form-label">Display Name</label>
                            <input type="text" class="form-control" id="newUserName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newUserEmail" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="newUserEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="newUserPassword" class="form-label">Password (min 6 chars)</label>
                            <input type="password" class="form-control" id="newUserPassword" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label for="newUserInitialBalance" class="form-label">Initial Balance (₹)</label>
                            <input type="number" step="any" class="form-control" id="newUserInitialBalance" value="0" min="0">
                            <small class="text-muted">This will be added to Total Balance.</small>
                        </div>
                        <div id="addUserStatus" class="mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveNewUserBtn">Create User</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Registered Players Modal -->
    <div class="modal fade" id="registeredPlayersModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registeredPlayersModalTitle">Registered Players</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Tournament: <strong id="registeredPlayersTournamentName"></strong></p>
                    <div id="registeredPlayersStatus" class="mb-2"></div>
                    <div class="table-responsive">
                        <table class="table table-dark table-sm table-hover">
                            <thead>
                                <tr><th>User UID</th><th>Name</th><th>Email</th><th>Joined At</th></tr>
                            </thead>
                            <tbody id="registeredPlayersTableBody">
                                <tr><td colspan="4" class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Episodes List Modal -->
    <div class="modal fade" id="episodesListModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="episodesListModalTitle">Seasons & Episodes</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Movie: <strong id="episodesListMovieName"></strong></p>
                    <div id="episodesListStatus" class="mb-2"></div>
                    <div class="accordion" id="episodesListAccordion">
                        <!-- Accordion items will be injected here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============================= -->
    <!-- SEND NOTIFICATION MODAL  -->
    <!-- ============================= -->
    <div class="modal fade" id="notificationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Notification</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="notificationForm">
                        <div class="mb-3">
                            <label for="notificationTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="notificationTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="notificationMessage" class="form-label">Message</label>
                            <textarea class="form-control" id="notificationMessage" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="notificationAudience" class="form-label">Audience</label>
                            <select class="form-select" id="notificationAudience">
                                <option value="all" selected>All Users</option>
                                <option value="specific">Specific User</option>
                            </select>
                        </div>
                        <div class="mb-3" id="notificationSpecificUserDiv" style="display: none;">
                            <label for="notificationSpecificUserInput" class="form-label">Specific User UID</label>
                            <input type="text" class="form-control" id="notificationSpecificUserInput" placeholder="Enter the user's UID">
                        </div>
                        <div id="notificationStatus" class="mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="sendNotificationBtnModal">Send Notification</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, off, remove, serverTimestamp, limitToLast } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // ===============================================================
        // ================= !!! IMPORTANT !!! ===========================
        // Replace the placeholder values below with your actual Firebase project configuration.
        // And update your Firebase Storage Rules as instructed.
        // ===============================================================
        const firebaseConfig = {
  apiKey: "AIzaSyAJO8mcqLKWqBytrjPSmmXA9iv_ay-na5U",
  authDomain: "gyui-661f7.firebaseapp.com",
  databaseURL: "https://gyui-661f7-default-rtdb.firebaseio.com",
  projectId: "gyui-661f7",
  storageBucket: "gyui-661f7.firebasestorage.app",
  messagingSenderId: "9938589816",
  appId: "1:9938589816:web:64db467d728fa48866758d"
};
        // ===============================================================
        // --- ImgBB API KEY ---
        // ===============================================================
        const IMGBB_API_KEY = 'b74f2d8157600d34f0b10e9861d7d58b'; // IMPORTANT: Add your ImgBB API key here
        // ===============================================================


        // Initialize Firebase
        let app, db, auth, storage;
        try {
            if (firebaseConfig.apiKey.includes("YOUR_API_KEY") || firebaseConfig.projectId.includes("YOUR_PROJECT_ID")) {
                console.warn("Admin Panel: Firebase config using placeholder values. Replace them with your actual project details.");
                 document.body.innerHTML = `<div class="alert alert-danger m-5"><strong>Configuration Error:</strong> Firebase is not configured. Please edit the HTML file and replace the placeholder values in the <code>firebaseConfig</code> object with your actual Firebase project configuration.</div>`;
                 throw new Error("Firebase configuration is missing.");
             }
             app = initializeApp(firebaseConfig);
             db = getDatabase(app);
             auth = getAuth(app);
             storage = getStorage(app);
             console.log("Admin Panel: Firebase Initialized");
        } catch (error) {
             console.error("Admin Panel: Firebase initialization failed:", error);
             document.body.innerHTML = `<div class="alert alert-danger m-5"><strong>Critical Error:</strong> Could not connect to Firebase services. Check console, config, and network. Error: ${error.message}</div>`;
        }

        // DOM Elements Cache
        const getElement = (id) => document.getElementById(id);
        const querySel = (selector) => document.querySelector(selector);
        const querySelAll = (selector) => document.querySelectorAll(selector);
        const elements = {
             adminLoader: getElement('adminLoader'),
             authContainer: getElement('auth-container'),
             loginSection: getElement('admin-login-section'),
             setupSection: getElement('admin-setup-section'),
             mainArea: getElement('admin-main-area'),
             adminLoginForm: getElement('adminLoginForm'),
             adminEmailInput: getElement('adminEmail'),
             adminPasswordInput: getElement('adminPassword'),
             adminLoginStatus: getElement('adminLoginStatus'),
             adminSetupForm: getElement('adminSetupForm'),
             setupEmailInput: getElement('setupEmail'),
             setupPasswordInput: getElement('setupPassword'),
             setupStatus: getElement('adminSetupStatus'),
             adminUserEmailDisplay: getElement('adminUserEmailShort'),
             adminLogoutBtn: getElement('adminLogoutBtnHeader'),
             sidebar: getElement('adminSidebar'),
             sidebarLinks: querySelAll('#adminSidebar .nav-link'),
             sections: querySelAll('#adminMainContent .section'),
             adminPageTitle: getElement('adminPageTitle'),
             adminHeaderLogo: getElement('adminHeaderLogo'),
             // Dashboard
             dashboardSection: getElement('dashboard-section'),
             statTotalUsers: getElement('statTotalUsers'),
             statActiveTournaments: getElement('statActiveTournaments'),
             statPendingWithdrawals: getElement('statPendingWithdrawals'),
             statCompletedWithdrawals: getElement('statCompletedWithdrawals'),
             statRejectedWithdrawals: getElement('statRejectedWithdrawals'),
             statTotalGames: getElement('statTotalGames'),
             statTotalMovies: getElement('statTotalMovies'),
             statTotalReviews: getElement('statTotalReviews'),
             statTotalPromotions: getElement('statTotalPromotions'),
             statTotalMoviePromotions: getElement('statTotalMoviePromotions'),
             statFinishedTournaments: getElement('statFinishedTournaments'),
             statTotalImages: getElement('statTotalImages'),
             statTotalVideos: getElement('statTotalVideos'),
             statTotalFacebookLinks: getElement('statTotalFacebookLinks'),
             statTotalInstagramLinks: getElement('statTotalInstagramLinks'),
             statTotalTiktokLinks: getElement('statTotalTiktokLinks'),
             statTotalNotifications: getElement('statTotalNotifications'),
             statTopEarner: getElement('statTopEarner'),
             dashboardStatus: getElement('dashboardStatus'),
             pendingWithdrawalCountBadge: getElement('pendingWithdrawalCountBadge'),
             // Games
             gamesTableBody: getElement('gamesTableBody'),
             gameModalEl: getElement('gameModal'),
             gameModalTitle: getElement('gameModalTitle'),
             gameForm: getElement('gameForm'),
             gameEditId: getElement('gameEditId'),
             gameNameInput: getElement('gameName'),
             gameImageFileInput: getElement('gameImageFile'),
             gameImageUrlInput: getElement('gameImageUrl'),
             saveGameBtn: getElement('saveGameBtn'),
             gameStatus: getElement('gameStatus'),
             gamesStatus: getElement('gamesStatus'),
             addNewGameBtn: getElement('addNewGameBtn'),
             // Movies
             moviesTableBody: getElement('moviesTableBody'),
             movieModalEl: getElement('movieModal'),
             movieModalTitle: getElement('movieModalTitle'),
             movieForm: getElement('movieForm'),
             movieEditId: getElement('movieEditId'),
             movieNameInput: getElement('movieName'),
             movieImageUrlInput: getElement('movieImageUrl'),
             movieReleaseDateInput: getElement('movieReleaseDate'),
             movieCategoryIdSelect: getElement('movieCategoryId'),
             movieTagsInput: getElement('movieTags'),
             movieStoryInput: getElement('movieStory'),
             movieTrailerNameInput: getElement('movieTrailerName'),
             movieTrailerUrlInput: getElement('movieTrailerUrl'),
             movieAccessSelect: getElement('movieAccess'), // NEW
             movieLanguageInput: getElement('movieLanguage'), // NEW
             movieRatingInput: getElement('movieRating'), // NEW
             saveMovieBtn: getElement('saveMovieBtn'),
             movieStatus: getElement('movieStatus'),
             moviesStatus: getElement('moviesStatus'),
             addNewMovieBtn: getElement('addNewMovieBtn'),
             seasonsContainer: getElement('seasons-container'),
             addSeasonBtn: getElement('addSeasonBtn'),
             // Movie Categories
             movieCategoriesTableBody: getElement('movieCategoriesTableBody'),
             movieCategoryModalEl: getElement('movieCategoryModal'),
             movieCategoryModalTitle: getElement('movieCategoryModalTitle'),
             movieCategoryForm: getElement('movieCategoryForm'),
             movieCategoryEditId: getElement('movieCategoryEditId'),
             movieCategoryNameInput: getElement('movieCategoryName'),
             movieCategoryImageUrlInput: getElement('movieCategoryImageUrl'),
             movieCategoryImageFileInput: getElement('movieCategoryImageFile'),
             saveMovieCategoryBtn: getElement('saveMovieCategoryBtn'),
             movieCategoryStatus: getElement('movieCategoryStatus'),
             movieCategoriesStatus: getElement('movieCategoriesStatus'),
             addNewMovieCategoryBtn: getElement('addNewMovieCategoryBtn'),
            // Movie Reviews (Now Comments)
            movieReviewsTableBody: getElement('movieReviewsTableBody'),
            movieReviewsStatus: getElement('movieReviewsStatus'),
            replyModalEl: getElement('replyModal'),
            replyForm: getElement('replyForm'),
            replyMovieId: getElement('replyMovieId'),
            replyEpisodeId: getElement('replyEpisodeId'),
            replyCommentId: getElement('replyCommentId'),
            parentCommentText: getElement('parentCommentText'),
            replyText: getElement('replyText'),
            saveReplyBtn: getElement('saveReplyBtn'),
            replyStatus: getElement('replyStatus'),
             // App Promotions
             promotionsTableBody: getElement('promotionsTableBody'),
             promotionModalEl: getElement('promotionModal'),
             promotionModalTitle: getElement('promotionModalTitle'),
             promotionForm: getElement('promotionForm'),
             promotionEditId: getElement('promotionEditId'),
             promoImageFileInput: getElement('promoImageFile'),
             promoImageUrlInput: getElement('promoImageUrl'),
             promoLinkInput: getElement('promoLink'),
             savePromotionBtn: getElement('savePromotionBtn'),
             promotionStatus: getElement('promotionStatus'),
             promotionsStatus: getElement('promotionsStatus'),
             addNewPromotionBtn: getElement('addNewPromotionBtn'),
            // Movie Promotions
            moviePromotionsTableBody: getElement('moviePromotionsTableBody'),
            moviePromotionModalEl: getElement('moviePromotionModal'),
            moviePromotionModalTitle: getElement('moviePromotionModalTitle'),
            moviePromotionForm: getElement('moviePromotionForm'),
            moviePromotionEditId: getElement('moviePromotionEditId'),
            moviePromoImageFileInput: getElement('moviePromoImageFile'),
            moviePromoImageUrlInput: getElement('moviePromoImageUrl'),
            moviePromoLinkInput: getElement('moviePromoLink'),
            saveMoviePromotionBtn: getElement('saveMoviePromotionBtn'),
            moviePromotionStatus: getElement('moviePromotionStatus'),
            moviePromotionsStatus: getElement('moviePromotionsStatus'),
            addNewMoviePromotionBtn: getElement('addNewMoviePromotionBtn'),
             // Tournaments
             tournamentsTableBody: getElement('tournamentsTableBody'),
             addTournamentModalEl: getElement('addTournamentModal'),
             tournamentForm: getElement('tournamentForm'),
             tournamentModalTitle: getElement('tournamentModalTitle'),
             tournamentEditId: getElement('tournamentEditId'),
             tournamentGameSelect: getElement('tournamentGame'),
             tournamentNameInput: getElement('tournamentName'),
             tournamentStartTimeInput: getElement('tournamentStartTime'),
             tournamentStatusSelect: getElement('tournamentStatus'),
             tournamentEntryFeeInput: getElement('tournamentEntryFee'),
             tournamentPrizePoolInput: getElement('tournamentPrizePool'),
             tournamentPerKillInput: getElement('tournamentPerKill'),
             tournamentMaxPlayersInput: getElement('tournamentMaxPlayers'),
             tournamentTagsInput: getElement('tournamentTags'),
             tournamentImageUrlInput: getElement('tournamentImageUrl'),
             tournamentVideoUrlInput: getElement('tournamentVideoUrl'),
             tournamentFacebookUrlInput: getElement('tournamentFacebookUrl'),
             tournamentInstagramUrlInput: getElement('tournamentInstagramUrl'),
             tournamentTiktokUrlInput: getElement('tournamentTiktokUrl'),
             tournamentDescriptionInput: getElement('tournamentDescription'),
             tournamentRoomIdInput: getElement('tournamentRoomId'),
             tournamentRoomPasswordInput: getElement('tournamentRoomPassword'),
             tournamentShowIdPassCheckbox: getElement('tournamentShowIdPass'),
             saveTournamentBtn: getElement('saveTournamentBtn'),
             addNewTournamentBtn: getElement('addNewTournamentBtn'),
             addTournamentStatus: getElement('addTournamentStatus'),
             tournamentsStatus: getElement('tournamentsStatus'),
             // Users
             usersTableBody: getElement('usersTableBody'),
             userSearchInput: getElement('userSearchInput'),
             userModalEl: getElement('userModal'),
             userModalTitle: getElement('userModalTitle'),
             userDetailUid: getElement('userDetailUid'),
             userDetailEmail: getElement('userDetailEmail'),
             userDetailName: getElement('userDetailName'),
             userDetailCreatedAt: getElement('userDetailCreatedAt'),
             userDetailBalance: getElement('userDetailBalance'),
             userDetailWinning: getElement('userDetailWinning'),
             userDetailBonus: getElement('userDetailBonus'),
             userDetailReferralCode: getElement('userDetailReferralCode'),
             userDetailReferredBy: getElement('userDetailReferredBy'),
             userDetailReferredCount: getElement('userDetailReferredCount'),
             userDetailStatus: getElement('userDetailStatus'),
             updateBalanceForm: getElement('updateBalanceForm'),
             editUserUid: getElement('editUserUid'),
             balanceUpdateAmountInput: getElement('balanceUpdateAmount'),
             balanceUpdateTypeSelect: getElement('balanceUpdateType'),
             balanceUpdateReasonInput: getElement('balanceUpdateReason'),
             balanceUpdateStatus: getElement('balanceUpdateStatus'),
             userBlockBtn: getElement('userBlockBtn'),
             userDeleteBtn: getElement('userDeleteBtn'),
             addUserModalEl: getElement('addUserModal'),
             addUserForm: getElement('addUserForm'),
             newUserNameInput: getElement('newUserName'),
             newUserEmailInput: getElement('newUserEmail'),
             newUserPasswordInput: getElement('newUserPassword'),
             newUserInitialBalanceInput: getElement('newUserInitialBalance'),
             saveNewUserBtn: getElement('saveNewUserBtn'),
             addUserStatus: getElement('addUserStatus'),
             usersStatus: getElement('usersStatus'),
             // Withdrawals
             pendingWithdrawalsTableBody: getElement('pendingWithdrawalsTableBody'),
             completedWithdrawalsTableBody: getElement('completedWithdrawalsTableBody'),
             rejectedWithdrawalsTableBody: getElement('rejectedWithdrawalsTableBody'),
             withdrawalActionModalEl: getElement('withdrawalActionModal'),
             withdrawalDetailId: getElement('withdrawalDetailId'),
             withdrawalDetailUser: getElement('withdrawalDetailUser'),
             withdrawalDetailUserUid: getElement('withdrawalDetailUserUid'),
             withdrawalDetailAmount: getElement('withdrawalDetailAmount'),
             withdrawalDetailMethod: getElement('withdrawalDetailMethod'),
             withdrawalRejectReasonInput: getElement('withdrawalRejectReason'),
             withdrawalApproveNoteInput: getElement('withdrawalApproveNote'),
             withdrawalActionStatus: getElement('withdrawalActionStatus'),
             rejectWithdrawalBtn: getElement('rejectWithdrawalBtn'),
             approveWithdrawalBtn: getElement('approveWithdrawalBtn'),
             withdrawalsStatus: getElement('withdrawalsStatus'),
             // Registered Players Modal
             registeredPlayersModalEl: getElement('registeredPlayersModal'),
             registeredPlayersTournamentName: getElement('registeredPlayersTournamentName'),
             registeredPlayersTableBody: getElement('registeredPlayersTableBody'),
             registeredPlayersStatus: getElement('registeredPlayersStatus'),
             // Episodes List Modal
            episodesListModalEl: getElement('episodesListModal'),
            episodesListMovieName: getElement('episodesListMovieName'),
            episodesListAccordion: getElement('episodesListAccordion'),
            episodesListStatus: getElement('episodesListStatus'),
             // Settings
             appSettingsForm: getElement('appSettingsForm'),
             settingLogoUrlInput: getElement('settingLogoUrl'),
             settingAppNameInput: getElement('settingAppName'),
             settingsStatus: getElement('settingsStatus'),
            changePasswordForm: getElement('changePasswordForm'),
            changePasswordStatus: getElement('changePasswordStatus'),
            // Theme
            themeStatus: getElement('themeStatus'),
            customThemeForm: getElement('customThemeForm'),
            themeColorPickers: querySelAll('#customThemeForm input[type="color"]'),
            saveThemeBtn: getElement('saveThemeBtn'),
            resetThemeBtn: getElement('resetThemeBtn'),
             // Demo Data
             addDemoDataBtn: getElement('addDemoDataBtn'),
             // Transactions
             transactionsTableBody: getElement('transactionsTableBody'),
             transactionSearchInput: getElement('transactionSearchInput'),
             transactionsStatus: getElement('transactionsStatus'),
            // Notifications
            notificationsSection: getElement('notifications-section'),
            notificationsTableBody: getElement('notificationsTableBody'),
            notificationsStatus: getElement('notificationsStatus'),
            notificationModalEl: getElement('notificationModal'),
            notificationForm: getElement('notificationForm'),
            notificationTitleInput: getElement('notificationTitle'),
            notificationMessageInput: getElement('notificationMessage'),
            notificationAudienceSelect: getElement('notificationAudience'),
            notificationSpecificUserDiv: getElement('notificationSpecificUserDiv'),
            notificationSpecificUserInput: getElement('notificationSpecificUserInput'),
            sendNotificationBtnModal: getElement('sendNotificationBtnModal'),
            notificationStatus: getElement('notificationStatus'),
            // Leaderboard
            leaderboardSection: getElement('leaderboard-section'),
            leaderboardTableBody: getElement('leaderboardTableBody'),
            leaderboardStatus: getElement('leaderboardStatus'),
        };

        // Bootstrap Modal/Offcanvas Instances Cache
        let componentInstances = {};
        const getComponentInstance = (element, componentType = 'Modal') => {
            if (!element) return null;
            const instanceKey = `${componentType}-${element.id}`;
            if (!componentInstances[instanceKey]) {
                try {
                     if (componentType === 'Modal') componentInstances[instanceKey] = new bootstrap.Modal(element);
                     else if (componentType === 'Offcanvas') componentInstances[instanceKey] = new bootstrap.Offcanvas(element);
                     else if (componentType === 'Tab') componentInstances[instanceKey] = new bootstrap.Tab(element);
                     else if (componentType === 'Alert') componentInstances[instanceKey] = new bootstrap.Alert(element);
                     else if (componentType === 'Toast') componentInstances[instanceKey] = new bootstrap.Toast(element);
                     else { console.warn("Unknown Bootstrap component type:", componentType); return null; }
                } catch (e) {
                    console.error(`Error creating Bootstrap ${componentType} instance for #${element.id}:`, e);
                    return null;
                }
            }
            return componentInstances[instanceKey];
        }
        const getModalInstance = (element) => getComponentInstance(element, 'Modal');
        const getOffcanvasInstance = (element) => getComponentInstance(element, 'Offcanvas');

        // --- App State ---
        let currentAdminUser = null;
        let currentWithdrawalAction = { id: null, type: null, userId: null };
        let currentEditingTournamentId = null;
        let gameDataCache = {}; 
        let movieCategoryCache = {};
        let moviesDataCache = {};
        let userDataCache = {}; 
        let fullUserDataCache = {};
        let allTransactionsCache = [];
        let dbListeners = {};
        let isAdminSetupComplete = false;
        let designatedAdminUid = null;
        let appSettings = {};

        // Theme Definitions
        const defaultTheme = {
            '--primary-bg': '#0F172A','--secondary-bg': '#1E293B','--card-bg': '#1E293B','--text-primary': '#E2E8F0','--text-secondary': '#94A3B8','--accent-color': '#FACC15','--primary-button-bg': '#3B82F6','--border-color': '#334155',
        };
        const crimsonTheme = {
            '--primary-bg': '#1a0005','--secondary-bg': '#2e0009','--card-bg': '#2e0009','--text-primary': '#fce7f3','--text-secondary': '#e9a8d9','--accent-color': '#f43f5e','--primary-button-bg': '#be185d','--border-color': '#500724',
        };
        const oceanicTheme = {
            '--primary-bg': '#0c1445','--secondary-bg': '#182157','--card-bg': '#182157','--text-primary': '#e0e7ff','--text-secondary': '#a5b4fc','--accent-color': '#38bdf8','--primary-button-bg': '#4338ca','--border-color': '#312e81',
        };

        // --- Admin Auth & Security ---
        function isDesignatedAdmin(user) {
            if (!user) return false;
            if (!designatedAdminUid) {
                 console.warn("Designated Admin UID check failed: UID not loaded yet.");
                 return false;
            }
            return user.uid === designatedAdminUid;
        }

        // --- Utility Functions ---
        const showLoader = (show) => { if (elements.adminLoader) elements.adminLoader.style.display = show ? 'flex' : 'none'; };
        function showStatus(element, message, type = 'danger', autohide = 5000) {
            if (!element) { console.warn("showStatus called with null element for message:", message); return; }
             const alertId = `status-alert-${element.id || Math.random().toString(36).substring(2)}`;
             element.style.display = 'block';
             element.innerHTML = `<div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">${sanitizeHTML(message)}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
             if (autohide && typeof autohide === 'number' && autohide > 0) {
                setTimeout(() => {
                    const currentAlert = getElement(alertId);
                    if (currentAlert) {
                        try { const bsAlert = getComponentInstance(currentAlert, 'Alert'); if (bsAlert) bsAlert.close(); else currentAlert.remove(); } catch (e) { console.warn("Error closing alert:", e); currentAlert.remove(); }
                    }
                }, autohide);
            }
        }
        function clearStatus(element) { if (!element) return; element.innerHTML = ''; }
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const tsNumber = Number(timestamp);
            if (isNaN(tsNumber) || tsNumber <= 0) return 'Invalid Date';
            try { return new Date(tsNumber).toLocaleString([], { dateStyle: 'short', timeStyle: 'short'}); } catch (e) { console.warn("Error formatting date:", timestamp, e); return 'Invalid Date'; }
        };
        const formatCurrency = (amount) => {
            const num = Number(amount); return isNaN(num) ? '₹--' : `₹${num.toFixed(2)}`;
        }
        function sanitizeHTML(str) {
             if (str == null) return '';
             const temp = document.createElement('div'); temp.textContent = String(str); return temp.innerHTML;
        }
        function copyToClipboard(targetSelector) {
            const copyIcon = event?.target.closest('.copy-btn');
            const context = copyIcon?.closest('.modal-body, tr');
            const element = context?.querySelector(targetSelector);
            const textToCopy = element?.textContent?.trim();
            if (!textToCopy) { console.warn("Copy target empty or not found:", targetSelector); return; }
            navigator.clipboard.writeText(textToCopy).then(() => {
                const toastEl = document.createElement('div');
                toastEl.className = 'toast position-fixed bottom-0 end-0 p-3 m-3 text-bg-success border-0';
                toastEl.innerHTML = '<div class="toast-body">Copied!</div>';
                document.body.appendChild(toastEl);
                const toast = getComponentInstance(toastEl, 'Toast');
                if(toast) toast.show();
                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            }).catch(err => { console.warn('Clipboard writeText failed: ', err); alert('Could not copy.'); });
        }
        const tableLoadingPlaceholderHtml = (cols) => `<tr class="loading-placeholder"><td colspan="${cols}"><div class="placeholder w-100 py-3"></div></td></tr>`.repeat(3);
        
        // --- NEW --- Function to format star ratings
        function formatRatingStars(rating) {
            const numRating = Number(rating);
            if (isNaN(numRating) || numRating <= 0) {
                return '<span class="text-muted">No rating</span>';
            }
            let starsHtml = '<span class="rating-stars">';
            for (let i = 1; i <= 5; i++) {
                starsHtml += `<i class="bi ${i <= numRating ? 'bi-star-fill' : 'bi-star'}"></i>`;
            }
            starsHtml += '</span>';
            return starsHtml;
        }

        // --- UI Functions ---
        function showAdminSection(sectionId) {
             elements.sections.forEach(sec => sec.classList.remove('active'));
             const targetSection = getElement(sectionId);
             if (targetSection) {
                 targetSection.classList.add('active');
                 const linkElement = querySel(`#adminSidebar .nav-link[data-section="${sectionId}"]`);
                 let title = 'Admin Panel';
                 if (linkElement) {
                     const linkText = linkElement.textContent.trim() || sectionId.replace('-section', '').replace('-', ' ');
                     title = linkText.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                     const badge = linkElement.querySelector('.badge');
                     if (badge) { title = title.replace(badge.textContent, '').trim(); }
                 }
                 if(elements.adminPageTitle) elements.adminPageTitle.textContent = title;
                 elements.sidebarLinks?.forEach(link => { link.classList.toggle('active', link.dataset.section === sectionId); });
                 loadDataForSection(sectionId);
                 const sidebar = getOffcanvasInstance(elements.sidebar);
                 if (sidebar?._isShown) sidebar.hide();
             } else {
                 console.error("Section element not found:", sectionId);
                 showAdminSection('dashboard-section'); // Fallback
             }
        }
        function loadDataForSection(sectionId) {
             if (!currentAdminUser || !isDesignatedAdmin(currentAdminUser)) return;
             console.log(`Loading data for section: ${sectionId}`);
             // Clear all status areas
             querySelAll('div[id$="Status"]').forEach(el => clearStatus(el));

             switch(sectionId) {
                 case 'dashboard-section': loadDashboardStats(); break;
                 case 'games-section': loadGames(); break;
                 case 'movies-section': loadMovies(); break;
                 case 'movie-categories-section': loadMovieCategories(); break;
                 case 'movie-reviews-section': loadMovieReviews(); break;
                 case 'promotions-section': loadPromotions(); break;
                 case 'movie-promotions-section': loadMoviePromotions(); break;
                 case 'tournaments-section': loadTournaments(); break;
                 case 'users-section': loadUsers(); break;
                 case 'leaderboard-section': loadLeaderboard(); break;
                 case 'notifications-section': loadNotifications(); break;
                 case 'withdrawals-section': loadWithdrawals('pending'); loadWithdrawals('completed'); loadWithdrawals('rejected'); break;
                 case 'settings-section': loadSettings(); break;
                 case 'theme-section': loadThemeSettings(); break;
                 case 'transactions-section': loadTransactions(); break;
                 default: console.warn("Unknown section requested:", sectionId); showStatus(elements.dashboardStatus, `Unknown section requested: ${sectionId}`, "warning");
             }
         }

        // --- Firebase Auth & Setup ---
        async function loginAdmin(event) { event.preventDefault(); if (!auth) return; const email = elements.adminEmailInput.value; const password = elements.adminPasswordInput.value; clearStatus(elements.adminLoginStatus); showLoader(true); try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Admin Login Error:", error); let message = `Login Failed: ${error.code}`; if (error.code === 'auth/network-request-failed') { message = "Login Failed: Network error."; } else if (['auth/invalid-credential', 'auth/wrong-password', 'auth/user-not-found', 'auth/invalid-email'].includes(error.code)) { message = "Login Failed: Invalid email or password."; } else if (error.code === 'auth/too-many-requests') { message = "Login Failed: Too many attempts."; } showStatus(elements.adminLoginStatus, message, 'danger', false); } finally { showLoader(false); } }
        async function logoutAdminUser() { if (!auth) return; showLoader(true); try { await signOut(auth); } catch (error) { console.error("Admin Logout Error:", error); alert("Logout failed: " + error.message); } }
        async function checkAdminSetup() { if (!db) return false; const adminConfigRef = ref(db, 'adminConfig'); try { const snapshot = await get(adminConfigRef); if (snapshot.exists()) { const d = snapshot.val(); isAdminSetupComplete = d.setupComplete === true; designatedAdminUid = d.adminUid || null; } else { isAdminSetupComplete = false; designatedAdminUid = null; } return isAdminSetupComplete; } catch (error) { console.error("Error checking admin setup:", error); const el = elements.loginSection?.style.display === 'block' ? elements.adminLoginStatus : elements.setupStatus; if (el) showStatus(el, `Config check error: ${error.message}. Check Rules.`, "danger", false); return false; } }
        async function setupAdmin(event) { event.preventDefault(); if (!auth || !db || isAdminSetupComplete) return; const email = elements.setupEmailInput.value.trim(); const password = elements.setupPasswordInput.value; clearStatus(elements.setupStatus); if (password.length < 6) { showStatus(elements.setupStatus, "Password min 6 chars.", "warning"); return; } showLoader(true); try { const cred = await createUserWithEmailAndPassword(auth, email, password); const uid = cred.user.uid; await set(ref(db, 'adminConfig'), { setupComplete: true, adminUid: uid }); await signOut(auth); alert("Admin account created! Please login now."); await handleInitialLoad(); } catch (error) { console.error("Admin Setup Error:", error); let message = `Setup failed: ${error.message}`; if (error.code === 'auth/email-already-in-use') message = "Email already in use."; else if (error.code === 'permission-denied') message = "Setup failed: Permission denied writing config. Check Firebase Rules for '/adminConfig'."; showStatus(elements.setupStatus, message, "danger", false); } finally { showLoader(false); } }
        async function handleInitialLoad() { if (!auth || !db) return; showLoader(true); await checkAdminSetup(); elements.setupSection.style.display = 'none'; elements.loginSection.style.display = 'none'; elements.mainArea.style.display = 'none'; elements.authContainer.style.display = 'block'; if (!isAdminSetupComplete) { elements.setupSection.style.display = 'block'; } else { elements.loginSection.style.display = 'block'; } showLoader(false); }
        async function handleAdminAuthStateChange(user) { if (!auth || !db) return; showLoader(true); currentAdminUser = user; detachAllAdminListeners(); if (user) { if (!designatedAdminUid) await checkAdminSetup(); if (isDesignatedAdmin(user)) { if (elements.adminUserEmailDisplay) elements.adminUserEmailDisplay.textContent = user.email; elements.authContainer.style.display = 'none'; elements.mainArea.style.display = 'block'; await loadSettings(); showAdminSection('dashboard-section'); setupRealtimeAdminListeners(); } else { alert(`Access Denied. ${user.email} is not the designated admin.`); await logoutAdminUser(); return; } } else { currentAdminUser = null; designatedAdminUid = null; isAdminSetupComplete = false; elements.mainArea.style.display = 'none'; elements.authContainer.style.display = 'block'; gameDataCache = {}; userDataCache = {}; fullUserDataCache = {}; allTransactionsCache = []; appSettings = {}; await handleInitialLoad(); } setTimeout(() => showLoader(false), 150); }

        // --- Database Load Functions ---
        async function loadDashboardStats() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            Object.values(elements).filter(el => el && el.id?.startsWith('stat')).forEach(el => el.textContent = '...');
            
            const refs = {
                users: ref(db, 'users'), games: ref(db, 'games'), movies: ref(db, 'movies'), promotions: ref(db, 'promotions'),
                moviePromotions: ref(db, 'moviePromotions'), tournaments: ref(db, 'tournaments'), withdrawals: ref(db, 'withdrawals'),
                notifications: ref(db, 'notifications'), comments: ref(db, 'comments')
            };
            
            const queries = {
                pendingW: query(refs.withdrawals, orderByChild('status'), equalTo('pending')),
                completedW: query(refs.withdrawals, orderByChild('status'), equalTo('completed')),
                rejectedW: query(refs.withdrawals, orderByChild('status'), equalTo('rejected')),
                topEarner: query(refs.users, orderByChild('totalEarnings'), limitToLast(1))
            };

            const results = await Promise.allSettled([
                get(refs.users), get(refs.games), get(refs.promotions), get(refs.tournaments),
                get(queries.pendingW), get(queries.completedW), get(queries.rejectedW),
                get(refs.notifications), get(queries.topEarner), get(refs.movies), get(refs.moviePromotions),
                get(refs.comments)
            ]);

            const getCount = (result) => result.status === 'fulfilled' && result.value.exists() ? result.value.size : 0;
            const isError = (result) => result.status !== 'fulfilled';

            elements.statTotalUsers.textContent = isError(results[0]) ? 'Err' : getCount(results[0]);
            elements.statTotalGames.textContent = isError(results[1]) ? 'Err' : getCount(results[1]);
            elements.statTotalPromotions.textContent = isError(results[2]) ? 'Err' : getCount(results[2]);
            elements.statPendingWithdrawals.textContent = isError(results[4]) ? 'Err' : getCount(results[4]);
            elements.statCompletedWithdrawals.textContent = isError(results[5]) ? 'Err' : getCount(results[5]);
            elements.statRejectedWithdrawals.textContent = isError(results[6]) ? 'Err' : getCount(results[6]);
            elements.statTotalNotifications.textContent = isError(results[7]) ? 'Err' : getCount(results[7]);
            elements.statTotalMovies.textContent = isError(results[9]) ? 'Err' : getCount(results[9]);
            elements.statTotalMoviePromotions.textContent = isError(results[10]) ? 'Err' : getCount(results[10]);
            
            // Corrected Comment/Review Count
            if (isError(results[11])) {
                elements.statTotalReviews.textContent = 'Err';
            } else {
                let commentCount = 0;
                if (results[11].value.exists()) {
                    results[11].value.forEach(movieSnap => {
                        movieSnap.forEach(episodeSnap => {
                            commentCount += episodeSnap.size;
                        });
                    });
                }
                elements.statTotalReviews.textContent = commentCount;
            }

            if (isError(results[3])) {
                elements.statActiveTournaments.textContent = 'Err'; elements.statFinishedTournaments.textContent = 'Err';
                elements.statTotalImages.textContent = 'Err'; elements.statTotalVideos.textContent = 'Err';
                elements.statTotalFacebookLinks.textContent = 'Err'; elements.statTotalInstagramLinks.textContent = 'Err';
                elements.statTotalTiktokLinks.textContent = 'Err';
            } else {
                let active = 0, finished = 0, images = getCount(results[1]) + getCount(results[2]), videos = 0, fb = 0, ig = 0, tt = 0;
                if (results[3].value.exists()) {
                    results[3].value.forEach(snap => {
                        const t = snap.val();
                        if (t.imageUrl) images++; if (t.videoUrl) videos++; if (t.facebookUrl) fb++;
                        if (t.instagramUrl) ig++; if (t.tiktokUrl) tt++;
                        if (['ongoing', 'upcoming'].includes(t.status)) active++; else if (['completed', 'result', 'cancelled'].includes(t.status)) finished++;
                    });
                }
                elements.statActiveTournaments.textContent = active; elements.statFinishedTournaments.textContent = finished;
                elements.statTotalImages.textContent = images; elements.statTotalVideos.textContent = videos;
                elements.statTotalFacebookLinks.textContent = fb; elements.statTotalInstagramLinks.textContent = ig;
                elements.statTotalTiktokLinks.textContent = tt;
            }

            if (isError(results[8])) {
                elements.statTopEarner.textContent = 'Error';
            } else if (results[8].value.exists()) {
                const topUserData = Object.values(results[8].value.val())[0];
                elements.statTopEarner.innerHTML = `${sanitizeHTML(topUserData.displayName)} <br><small>${formatCurrency(topUserData.totalEarnings)}</small>`;
            } else {
                elements.statTopEarner.textContent = 'N/A';
            }
        }
        async function loadGames() {
             if (!db || !isDesignatedAdmin(currentAdminUser)) return;
             elements.gamesTableBody.innerHTML = tableLoadingPlaceholderHtml(4);
             gameDataCache = {};
             try {
                 const snapshot = await get(ref(db, 'games'));
                 let tableHtml = '';
                 if (snapshot.exists()) {
                     snapshot.forEach(childSnapshot => {
                         const gameId = childSnapshot.key; const game = childSnapshot.val();
                         if (game && game.name) {
                            gameDataCache[gameId] = game.name;
                            tableHtml += `<tr><td><img src="${sanitizeHTML(game.imageUrl || '')}" class="preview-img"></td><td>${sanitizeHTML(game.name)}</td><td><small class="text-muted">${sanitizeHTML(gameId)}</small> <i class="bi bi-clipboard copy-btn ms-1" data-target="td:nth-child(3) > small"></i></td><td class="action-buttons"><button class="btn btn-sm btn-info btn-edit-game" data-id="${sanitizeHTML(gameId)}"><i class="bi bi-pencil-square"></i></button> <button class="btn btn-sm btn-danger btn-delete-game" data-id="${sanitizeHTML(gameId)}"><i class="bi bi-trash"></i></button></td></tr>`;
                         }
                     });
                 }
                 elements.gamesTableBody.innerHTML = tableHtml || `<tr><td colspan="4" class="text-center p-3 text-muted">No games found.</td></tr>`;
             } catch (error) { elements.gamesTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-3 text-danger">Error: ${error.message}</td></tr>`; }
        }
        async function loadMovies() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            elements.moviesTableBody.innerHTML = tableLoadingPlaceholderHtml(10);
            if (Object.keys(movieCategoryCache).length === 0) await loadMovieCategories();
            moviesDataCache = {};
            try {
                const snapshot = await get(ref(db, 'movies'));
                let tableHtml = '';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const movieId = childSnapshot.key;
                        const movie = childSnapshot.val();
                         moviesDataCache[movieId] = movie;
                        if (movie && movie.name) {
                            const categoryName = movieCategoryCache[movie.categoryId] || 'Uncategorized';
                            const tagsHtml = (movie.tags || []).map(tag => `<span class="tag-badge">${sanitizeHTML(tag)}</span>`).join(' ');
                            const releaseDate = movie.releaseDate ? sanitizeHTML(movie.releaseDate) : 'N/A';
                            
                            const access = movie.access || 'Free';
                            const language = movie.language || 'N/A';
                            const rating = movie.rating ? `${movie.rating} <i class="bi bi-star-fill text-warning"></i>` : 'N/A';
                            const accessBadge = access === 'Free' ? 'success' : access === 'VPN' ? 'info' : 'warning';

                            let seasonCountText = '0';
                            if (movie.seasons) {
                                const count = Object.keys(movie.seasons).length;
                                seasonCountText = `${count} Season${count !== 1 ? 's' : ''}`;
                            }
                            const seasonCell = `<button class="btn btn-sm btn-outline-info btn-view-episodes" data-id="${sanitizeHTML(movieId)}">${seasonCountText}</button>`;

                            tableHtml += `
                                <tr>
                                    <td><img src="${sanitizeHTML(movie.imageUrl || '')}" class="preview-img"></td>
                                    <td>${sanitizeHTML(movie.name)}</td>
                                    <td>${sanitizeHTML(categoryName)}</td>
                                    <td><span class="badge text-bg-${accessBadge}">${sanitizeHTML(access)}</span></td>
                                    <td>${sanitizeHTML(language)}</td>
                                    <td>${rating}</td>
                                    <td>${seasonCell}</td>
                                    <td>${releaseDate}</td>
                                    <td>${tagsHtml}</td>
                                    <td class="action-buttons">
                                        <button class="btn btn-sm btn-info btn-edit-movie" data-id="${sanitizeHTML(movieId)}"><i class="bi bi-pencil-square"></i></button>
                                        <button class="btn btn-sm btn-danger btn-delete-movie" data-id="${sanitizeHTML(movieId)}"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>`;
                        }
                    });
                }
                elements.moviesTableBody.innerHTML = tableHtml || `<tr><td colspan="10" class="text-center p-3 text-muted">No movies found.</td></tr>`;
            } catch (error) {
                elements.moviesTableBody.innerHTML = `<tr><td colspan="10" class="text-center p-3 text-danger">Error: ${error.message}</td></tr>`;
            }
        }
        async function loadMovieCategories() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            elements.movieCategoriesTableBody.innerHTML = tableLoadingPlaceholderHtml(3);
            movieCategoryCache = {};
            try {
                const snapshot = await get(ref(db, 'movieCategories'));
                let tableHtml = '';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const categoryId = childSnapshot.key;
                        const category = childSnapshot.val();
                        if (category && category.name) {
                            movieCategoryCache[categoryId] = category.name;
                            tableHtml += `
                                <tr>
                                    <td><img src="${sanitizeHTML(category.imageUrl || '')}" class="preview-img"></td>
                                    <td>${sanitizeHTML(category.name)}</td>
                                    <td class="action-buttons">
                                        <button class="btn btn-sm btn-info btn-edit-movie-category" data-id="${sanitizeHTML(categoryId)}"><i class="bi bi-pencil-square"></i></button>
                                        <button class="btn btn-sm btn-danger btn-delete-movie-category" data-id="${sanitizeHTML(categoryId)}"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>`;
                        }
                    });
                }
                elements.movieCategoriesTableBody.innerHTML = tableHtml || `<tr><td colspan="3" class="text-center p-3 text-muted">No movie categories found.</td></tr>`;
            } catch (error) {
                elements.movieCategoriesTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-3 text-danger">Error: ${error.message}</td></tr>`;
            }
        }
        async function loadMovieReviews() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            elements.movieReviewsTableBody.innerHTML = tableLoadingPlaceholderHtml(6);
            try {
                const commentsRef = ref(db, 'comments');
                const snapshot = await get(commentsRef);
                let tableHtml = '';
                
                if (snapshot.exists()) {
                    const comments = [];
                    snapshot.forEach(movieSnap => {
                        const movieId = movieSnap.key;
                        movieSnap.forEach(episodeSnap => {
                            const episodeId = episodeSnap.key;
                            episodeSnap.forEach(commentSnap => {
                                comments.push({
                                    movieId,
                                    episodeId,
                                    commentId: commentSnap.key,
                                    ...commentSnap.val()
                                });
                            });
                        });
                    });
                    
                    comments.sort((a,b) => {
                        const aPinned = a.isPinned || false;
                        const bPinned = b.isPinned || false;
                        if (aPinned !== bPinned) {
                            return bPinned - aPinned; // Pinned comments first
                        }
                        return (b.timestamp || 0) - (a.timestamp || 0); // Then newest
                    });

                    for (const comment of comments) {
                        const movieName = moviesDataCache[comment.movieId]?.name || 'Unknown Movie';
                        // This part needs adjustment because episodes are now nested under seasons.
                        // For simplicity in this view, we'll just show the movie name.
                        // A more complex implementation could try to find the episode title across all seasons.
                        const userName = userDataCache[comment.authorId]?.displayName || comment.authorName || 'Unknown User';
                        
                        const isPinned = comment.isPinned || false;
                        const pinButtonIcon = isPinned ? 'bi-pin-angle-fill' : 'bi-pin-angle';
                        const pinButtonTitle = isPinned ? 'Unpin Comment' : 'Pin Comment';
                        const pinnedRowClass = isPinned ? 'table-info' : '';
                        const pinnedBadge = isPinned ? '<span class="badge text-bg-warning me-2">Pinned</span>' : '';
                        const ratingStars = formatRatingStars(comment.rating);

                        tableHtml += `
                            <tr class="${pinnedRowClass}">
                                <td>${sanitizeHTML(movieName)}</td>
                                <td>${sanitizeHTML(userName)}</td>
                                <td class="wrap-text">${pinnedBadge}${sanitizeHTML(comment.text)}</td>
                                <td>${ratingStars}</td>
                                <td>${formatDate(comment.timestamp)}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-sm btn-outline-warning btn-pin-comment" title="${pinButtonTitle}" data-movie-id="${sanitizeHTML(comment.movieId)}" data-episode-id="${sanitizeHTML(comment.episodeId)}" data-comment-id="${sanitizeHTML(comment.commentId)}" data-pinned="${isPinned}">
                                        <i class="bi ${pinButtonIcon}"></i>
                                    </button>
                                     <button class="btn btn-sm btn-outline-info btn-reply-comment" title="Reply to Comment" data-movie-id="${sanitizeHTML(comment.movieId)}" data-episode-id="${sanitizeHTML(comment.episodeId)}" data-comment-id="${sanitizeHTML(comment.commentId)}">
                                        <i class="bi bi-reply-fill"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger btn-delete-review" title="Delete Comment" data-movie-id="${sanitizeHTML(comment.movieId)}" data-episode-id="${sanitizeHTML(comment.episodeId)}" data-comment-id="${sanitizeHTML(comment.commentId)}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        
                        // Render Replies
                        if (comment.replies) {
                            Object.entries(comment.replies).forEach(([replyId, reply]) => {
                                 tableHtml += `
                                    <tr class="comment-reply-row ${pinnedRowClass}">
                                        <td></td>
                                        <td></td>
                                        <td class="wrap-text">
                                            <div class="d-flex">
                                                <div class="flex-shrink-0 me-3 text-info"><i class="bi bi-reply-all-fill"></i></div>
                                                <div class="flex-grow-1">
                                                    <strong>Admin Reply:</strong> ${sanitizeHTML(reply.text)}
                                                    <small class="text-muted d-block">${formatDate(reply.timestamp)}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td class="action-buttons">
                                             <button class="btn btn-sm btn-danger btn-delete-reply" title="Delete Reply" data-movie-id="${sanitizeHTML(comment.movieId)}" data-episode-id="${sanitizeHTML(comment.episodeId)}" data-comment-id="${sanitizeHTML(comment.commentId)}" data-reply-id="${sanitizeHTML(replyId)}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            });
                        }
                    }
                }
                elements.movieReviewsTableBody.innerHTML = tableHtml || `<tr><td colspan="6" class="text-center p-3 text-muted">No comments found.</td></tr>`;
            } catch (error) {
                console.error("Error loading movie comments:", error);
                elements.movieReviewsTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-danger">Error: ${error.message}</td></tr>`;
            }
        }
        async function loadPromotions() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            elements.promotionsTableBody.innerHTML = tableLoadingPlaceholderHtml(3);
            try {
                const snapshot = await get(ref(db, 'promotions'));
                let tableHtml = '';
                if(snapshot.exists()){
                    snapshot.forEach(child => {
                        const promoId = child.key; const promo = child.val();
                        if(promo && promo.imageUrl) {
                            const link = promo.link ? `<a href="${sanitizeHTML(promo.link)}" target="_blank">${sanitizeHTML(promo.link.substring(0,50))}...</a>` : 'N/A';
                            tableHtml += `<tr><td><img src="${sanitizeHTML(promo.imageUrl)}" class="preview-img"></td><td>${link}</td><td class="action-buttons"><button class="btn btn-sm btn-info btn-edit-promo" data-id="${sanitizeHTML(promoId)}"><i class="bi bi-pencil-square"></i></button> <button class="btn btn-sm btn-danger btn-delete-promo" data-id="${sanitizeHTML(promoId)}"><i class="bi bi-trash"></i></button></td></tr>`;
                        }
                    });
                }
                elements.promotionsTableBody.innerHTML = tableHtml || `<tr><td colspan="3" class="text-center p-3 text-muted">No app promotions found.</td></tr>`;
            } catch(e) { elements.promotionsTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-3 text-danger">Error: ${e.message}</td></tr>`;}
        }
        async function loadMoviePromotions() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            elements.moviePromotionsTableBody.innerHTML = tableLoadingPlaceholderHtml(3);
            try {
                const snapshot = await get(ref(db, 'moviePromotions'));
                let tableHtml = '';
                if(snapshot.exists()){
                    snapshot.forEach(child => {
                        const promoId = child.key; const promo = child.val();
                        if(promo && promo.imageUrl) {
                            const link = promo.link ? `<a href="${sanitizeHTML(promo.link)}" target="_blank">${sanitizeHTML(promo.link.substring(0,50))}...</a>` : 'N/A';
                            tableHtml += `<tr><td><img src="${sanitizeHTML(promo.imageUrl)}" class="preview-img"></td><td>${link}</td><td class="action-buttons"><button class="btn btn-sm btn-info btn-edit-movie-promo" data-id="${sanitizeHTML(promoId)}"><i class="bi bi-pencil-square"></i></button> <button class="btn btn-sm btn-danger btn-delete-movie-promo" data-id="${sanitizeHTML(promoId)}"><i class="bi bi-trash"></i></button></td></tr>`;
                        }
                    });
                }
                elements.moviePromotionsTableBody.innerHTML = tableHtml || `<tr><td colspan="3" class="text-center p-3 text-muted">No movie promotions found.</td></tr>`;
            } catch(e) { elements.moviePromotionsTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-3 text-danger">Error: ${e.message}</td></tr>`;}
        }
        async function loadTournaments() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            elements.tournamentsTableBody.innerHTML = tableLoadingPlaceholderHtml(13);
            if (Object.keys(gameDataCache).length === 0) await loadGames();
            try {
                const snapshot = await get(ref(db, 'tournaments'));
                let tableHtml = '';
                if(snapshot.exists()){
                    snapshot.forEach(child => {
                        const tId = child.key; const t = child.val();
                        if(t && t.name){
                            const gameName = gameDataCache[t.gameId] || 'Unknown';
                            const statusCls = t.status === 'ongoing' ? 'success' : t.status === 'upcoming' ? 'info' : 'secondary';
                            const players = `${t.registeredPlayers ? Object.keys(t.registeredPlayers).length : 0}${t.maxPlayers > 0 ? `/${t.maxPlayers}`:''}`;
                            const video = t.videoUrl ? `<a href="${sanitizeHTML(t.videoUrl)}" target="_blank"><i class="bi bi-play-btn"></i></a>` : 'N/A';
                            const fb = t.facebookUrl ? `<a href="${sanitizeHTML(t.facebookUrl)}" target="_blank"><i class="bi bi-facebook"></i></a>` : 'N/A';
                            const ig = t.instagramUrl ? `<a href="${sanitizeHTML(t.instagramUrl)}" target="_blank"><i class="bi bi-instagram"></i></a>` : 'N/A';
                            const tt = t.tiktokUrl ? `<a href="${sanitizeHTML(t.tiktokUrl)}" target="_blank"><i class="bi bi-tiktok"></i></a>` : 'N/A';
                            tableHtml += `<tr><td><img src="${sanitizeHTML(t.imageUrl || '')}" class="preview-img"></td><td>${sanitizeHTML(t.name)}</td><td>${gameName}</td><td>${formatCurrency(t.entryFee)}</td><td>${formatCurrency(t.prizePool)}</td><td>${formatDate(t.startTime)}</td><td><span class="badge text-bg-${statusCls}">${t.status}</span></td><td>${players}</td><td>${video}</td><td>${fb}</td><td>${ig}</td><td>${tt}</td><td class="action-buttons"><button class="btn btn-sm btn-info btn-edit-tournament" data-id="${tId}"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-secondary btn-view-registered" data-id="${tId}" data-name="${sanitizeHTML(t.name)}"><i class="bi bi-people"></i></button><button class="btn btn-sm btn-danger btn-delete-tournament" data-id="${tId}"><i class="bi bi-trash"></i></button></td></tr>`;
                        }
                    });
                }
                elements.tournamentsTableBody.innerHTML = tableHtml || `<tr><td colspan="13" class="text-center p-3 text-muted">No tournaments found.</td></tr>`;
            } catch(e) { elements.tournamentsTableBody.innerHTML = `<tr><td colspan="13" class="text-center p-3 text-danger">Error: ${e.message}</td></tr>`;}
        }
        
        // --- FIX: Made user data rendering more robust ---
        function renderUsersTable(usersArray) {
            let tableHtml = '';
            if (usersArray?.length > 0) {
                // Sort users alphabetically by display name
                usersArray.sort((a, b) => (a.displayName || 'z').localeCompare(b.displayName || 'z'));
                
                usersArray.forEach(user => {
                    // Safe data access with fallbacks
                    const uid = user.uid || 'N/A';
                    const displayName = user.displayName || 'N/A';
                    const email = user.email || 'N/A';
                    const balance = user.balance || 0;
                    const status = user.status || 'active';
                    const statusClass = status === 'active' ? 'success' : 'danger';

                    tableHtml += `
                        <tr>
                            <td><small class="text-muted">${sanitizeHTML(uid)}</small> <i class="bi bi-clipboard copy-btn ms-1" data-target="td:first-child > small"></i></td>
                            <td>${sanitizeHTML(displayName)}</td>
                            <td>${sanitizeHTML(email)}</td>
                            <td>${formatCurrency(balance)}</td>
                            <td><span class="badge text-bg-${statusClass}">${status}</span></td>
                            <td class="action-buttons">
                                <button class="btn btn-sm btn-info btn-view-user" data-id="${uid}"><i class="bi bi-eye"></i></button>
                                <button class="btn btn-sm btn-danger btn-delete-user" data-id="${uid}"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>`;
                });
            }
            elements.usersTableBody.innerHTML = tableHtml || `<tr><td colspan="6" class="text-center p-3 text-muted">No users found.</td></tr>`;
        }

        async function loadUsers() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            elements.usersTableBody.innerHTML = tableLoadingPlaceholderHtml(6);
            fullUserDataCache = {}; 
            userDataCache = {};
            elements.userSearchInput.value = '';

            const listenerKey = 'users';
            const usersRef = ref(db, 'users');

            // Detach previous listener if it exists
            if(dbListeners[listenerKey]) off(usersRef, 'value', dbListeners[listenerKey]);

            dbListeners[listenerKey] = onValue(usersRef, (snapshot) => {
                 const usersArray = [];
                 if (snapshot.exists()) {
                     snapshot.forEach(child => {
                         const user = child.val();
                         // --- FIX: Ensure user object is valid before processing ---
                         if (user && typeof user === 'object' && child.key) {
                             user.uid = child.key; // Make sure UID is always present
                             fullUserDataCache[user.uid] = user;
                             userDataCache[user.uid] = { displayName: user.displayName, email: user.email, status: user.status };
                             usersArray.push(user);
                         } else {
                            console.warn("Skipping invalid user record in database:", child.key, user);
                         }
                     });
                 }
                 renderUsersTable(usersArray);
            }, (error) => { 
                console.error("Firebase error loading users:", error); 
                elements.usersTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-danger">Error: ${error.message}</td></tr>`; 
            });
        }

        async function loadWithdrawals(status = 'pending') {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const tableBody = getElement(`${status}WithdrawalsTableBody`);
            if(!tableBody) return;
            tableBody.innerHTML = tableLoadingPlaceholderHtml(status==='pending'?5:6);
            const q = query(ref(db, 'withdrawals'), orderByChild('status'), equalTo(status));
            const listenerKey = `withdrawals-${status}`;
            if(dbListeners[listenerKey]) off(q, 'value', dbListeners[listenerKey]);
            dbListeners[listenerKey] = onValue(q, async (snapshot) => {
                let tableHtml = '';
                if(snapshot.exists()){
                    const withdrawals = [];
                    snapshot.forEach(child => withdrawals.push({ id: child.key, ...child.val() }));
                    withdrawals.sort((a,b) => (b.requestTimestamp || 0) - (a.requestTimestamp || 0));
                    for(const w of withdrawals){
                        let userDisplay = w.userId;
                        if(userDataCache[w.userId]) userDisplay = `${userDataCache[w.userId].displayName} (${userDataCache[w.userId].email})`;
                        else {
                            const uSnap = await get(ref(db, `users/${w.userId}`));
                            if(uSnap.exists()) { const u = uSnap.val(); userDisplay = `${u.displayName} (${u.email})`; userDataCache[w.userId] = { displayName: u.displayName, email: u.email }; }
                        }
                        const method = `${w.methodDetails?.methodName || 'N/A'} - ${w.methodDetails?.accountInfo || 'N/A'}`;
                        let row = `<tr><td>${formatDate(w.requestTimestamp)}</td>`;
                        if(status !== 'pending') row += `<td>${formatDate(w.processedAt)}</td>`;
                        row += `<td>${userDisplay}</td><td>${formatCurrency(w.amount)}</td><td>${method}</td>`;
                        if(status === 'pending') row += `<td class="action-buttons"><button class="btn btn-sm btn-success btn-approve-withdrawal" data-id="${w.id}"><i class="bi bi-check-circle"></i></button><button class="btn btn-sm btn-danger btn-reject-withdrawal" data-id="${w.id}"><i class="bi bi-x-circle"></i></button></td>`;
                        else if (status === 'completed') row += `<td>${sanitizeHTML(w.adminNote || '')}</td>`;
                        else if (status === 'rejected') row += `<td>${sanitizeHTML(w.rejectReason || '')}</td>`;
                        row += `</tr>`;
                        tableHtml += row;
                    }
                }
                tableBody.innerHTML = tableHtml || `<tr><td colspan="${status==='pending'?5:6}" class="text-center p-3 text-muted">No ${status} withdrawals.</td></tr>`;
            }, e => { tableBody.innerHTML = `<tr><td colspan="${status==='pending'?5:6}" class="text-center p-3 text-danger">Error: ${e.message}</td></tr>`;});
        }
        async function loadSettings() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            try {
                const snapshot = await get(ref(db, 'settings'));
                if (snapshot.exists()) {
                    appSettings = snapshot.val() || {};
                    getElement('settingLogoUrl').value = appSettings.logoUrl || '';
                    getElement('settingAppName').value = appSettings.appName || '';
                    getElement('settingMinWithdraw').value = appSettings.minWithdraw || 0;
                    getElement('settingReferralBonus').value = appSettings.referralBonus || 0;
                    getElement('settingSupportContact').value = appSettings.supportContact || '';
                    getElement('settingUpiDetails').value = appSettings.upiDetails || '';
                    getElement('settingPolicyPrivacy').value = appSettings.policyPrivacy || '';
                    getElement('settingPolicyTerms').value = appSettings.policyTerms || '';
                    getElement('settingPolicyRefund').value = appSettings.policyRefund || '';
                    getElement('settingPolicyFairPlay').value = appSettings.policyFairPlay || '';
                    if(elements.adminHeaderLogo) { elements.adminHeaderLogo.src = appSettings.logoUrl || ''; elements.adminHeaderLogo.style.display = appSettings.logoUrl ? 'block' : 'none'; }
                    document.title = `${appSettings.appName || 'Admin'} Panel`;
                }
            } catch (error) { console.error("Error loading settings:", error); }
        }
        function renderTransactionsTable(transactions) {
            const tableBody = elements.transactionsTableBody;
            if (!transactions || transactions.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-muted">No transactions found.</td></tr>`;
                return;
            }
            const formatTxType = (type) => (type || 'unknown').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            let tableHtml = '';
            transactions.forEach(tx => {
                const user = userDataCache[tx.userId] || { displayName: 'Unknown', email: tx.userId };
                const amount = Number(tx.amount || 0);
                const isDebit = tx.type?.includes('fee') || tx.type?.includes('deduct') || tx.type?.includes('join') || amount < 0;
                const amountDisplay = isDebit ? `<span class="text-danger">${formatCurrency(amount)}</span>` : `<span class="text-success">+${formatCurrency(amount)}</span>`;
                
                tableHtml += `
                    <tr>
                        <td>${formatDate(tx.timestamp)}</td>
                        <td>${sanitizeHTML(user.displayName)}<br><small class="text-muted">${sanitizeHTML(user.email)}</small></td>
                        <td>${formatTxType(tx.type)}</td>
                        <td>${amountDisplay}</td>
                        <td>${sanitizeHTML(tx.description || 'N/A')}</td>
                        <td>${tx.balanceAfter !== undefined ? formatCurrency(tx.balanceAfter) : 'N/A'}</td>
                    </tr>`;
            });
            tableBody.innerHTML = tableHtml;
        }

        // --- FIX: Optimized transaction loading ---
        async function loadTransactions() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            elements.transactionsTableBody.innerHTML = tableLoadingPlaceholderHtml(6);
            allTransactionsCache = [];
            try {
                // Fetch all transactions in a single read operation.
                const transactionsSnap = await get(ref(db, 'transactions'));
                if (!transactionsSnap.exists()) {
                    renderTransactionsTable([]);
                    return;
                }

                const combined = [];
                transactionsSnap.forEach(userTransactionsSnap => {
                    const uid = userTransactionsSnap.key;
                    userTransactionsSnap.forEach(txSnap => {
                        const txData = txSnap.val();
                        if (txData && typeof txData === 'object') {
                            txData.userId = uid; // Add the user ID to the transaction object
                            combined.push(txData);
                        }
                    });
                });
                
                combined.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                allTransactionsCache = combined;
                renderTransactionsTable(allTransactionsCache);
            } catch (error) {
                console.error("Error loading transactions:", error);
                elements.transactionsTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-danger">Error: ${error.message}</td></tr>`;
            }
        }


        // --- LEADERBOARD FUNCTIONS ---
        async function loadLeaderboard() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            elements.leaderboardTableBody.innerHTML = tableLoadingPlaceholderHtml(5);
            try {
                const usersSnap = await get(ref(db, 'users'));
                if (!usersSnap.exists()) {
                    elements.leaderboardTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3 text-muted">No users found.</td></tr>`;
                    return;
                }
                const usersArray = [];
                usersSnap.forEach(child => {
                    usersArray.push({ uid: child.key, ...child.val() });
                });
                
                usersArray.sort((a, b) => (b.totalEarnings || 0) - (a.totalEarnings || 0));

                let tableHtml = '';
                usersArray.forEach((user, index) => {
                    const rank = index + 1;
                    const winRate = user.totalMatches > 0 ? ((user.wonMatches || 0) / user.totalMatches * 100).toFixed(1) + '%' : '0%';
                    tableHtml += `
                        <tr>
                            <td><strong>#${rank}</strong></td>
                            <td>${sanitizeHTML(user.displayName)}<br><small class="text-muted">${sanitizeHTML(user.email)}</small></td>
                            <td class="text-success fw-bold">${formatCurrency(user.totalEarnings)}</td>
                            <td>${user.totalMatches || 0}</td>
                            <td>${winRate}</td>
                        </tr>
                    `;
                });
                elements.leaderboardTableBody.innerHTML = tableHtml || `<tr><td colspan="5" class="text-center p-3 text-muted">No users found.</td></tr>`;

            } catch (error) {
                console.error("Error loading leaderboard:", error);
                elements.leaderboardTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3 text-danger">Error: ${error.message}</td></tr>`;
                if(error.message.includes("Permission denied")) {
                    showStatus(elements.leaderboardStatus, "Permission Denied. Ensure admin has root read access in Firebase Rules.", "danger", false);
                }
            }
        }
        
        // --- NOTIFICATION FUNCTIONS ---
        async function loadNotifications() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            elements.notificationsTableBody.innerHTML = tableLoadingPlaceholderHtml(5);
            try {
                const snapshot = await get(ref(db, 'notifications'));
                let tableHtml = '';
                if (snapshot.exists()) {
                    const notifications = [];
                    snapshot.forEach(child => notifications.push({ id: child.key, ...child.val() }));
                    notifications.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                    for (const n of notifications) {
                        let audience = 'All Users';
                        if (n.audience && n.audience !== 'all') {
                           const user = userDataCache[n.audience] || (await get(ref(db, `users/${n.audience}`))).val();
                           audience = user ? `${user.displayName || 'N/A'} <small class="text-muted d-block">${n.audience}</small>` : `<span class="text-warning">User Deleted</span> <small class="text-muted d-block">${n.audience}</small>`;
                        }
                        tableHtml += `
                            <tr>
                                <td>${formatDate(n.timestamp)}</td>
                                <td class="wrap-text">${sanitizeHTML(n.title)}</td>
                                <td class="wrap-text">${sanitizeHTML(n.message)}</td>
                                <td>${audience}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-sm btn-danger btn-delete-notification" data-id="${sanitizeHTML(n.id)}"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>`;
                    }
                }
                elements.notificationsTableBody.innerHTML = tableHtml || `<tr><td colspan="5" class="text-center p-3 text-muted">No notifications sent yet.</td></tr>`;
            } catch (error) {
                console.error("Error loading notifications:", error);
                elements.notificationsTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3 text-danger">Error: ${error.message}</td></tr>`;
            }
        }
        async function sendNotification() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const statusEl = elements.notificationStatus; clearStatus(statusEl);
            const title = elements.notificationTitleInput.value.trim();
            const message = elements.notificationMessageInput.value.trim();
            const audience = elements.notificationAudienceSelect.value;
            const specificUid = elements.notificationSpecificUserInput.value.trim();
            if (!title || !message) { showStatus(statusEl, "Title and Message are required.", "warning"); return; }
            if (audience === 'specific' && !specificUid) { showStatus(statusEl, "Specific User UID is required.", "warning"); return; }
            const notificationData = { title, message, timestamp: serverTimestamp(), audience: audience === 'all' ? 'all' : specificUid, sentBy: currentAdminUser.uid };
            showLoader(true);
            try {
                await push(ref(db, 'notifications'), notificationData);
                getModalInstance(elements.notificationModalEl)?.hide();
                loadNotifications(); loadDashboardStats();
            } catch (error) { showStatus(statusEl, `Error: ${error.message}`, "danger", false); } 
            finally { showLoader(false); }
        }
        async function deleteNotification(notificationId) {
            if (!db || !notificationId || !confirm(`Delete notification?`)) return;
            showLoader(true);
            try {
                await remove(ref(db, `notifications/${notificationId}`));
                loadNotifications(); loadDashboardStats();
            } catch (error) { alert(`Error: ${error.message}`); } 
            finally { showLoader(false); }
        }
        async function deleteMovieReview(movieId, episodeId, commentId) {
            if (!db || !commentId || !confirm('Are you sure you want to delete this comment? This action cannot be undone.')) return;
            showLoader(true);
            try {
                await remove(ref(db, `comments/${movieId}/${episodeId}/${commentId}`));
                showStatus(elements.movieReviewsStatus, "Comment deleted successfully.", "success");
                loadMovieReviews();
                loadDashboardStats();
            } catch (error) {
                console.error("Error deleting comment:", error);
                showStatus(elements.movieReviewsStatus, `Error: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
            }
        }
        
        // --- COMMENT PIN & REPLY FUNCTIONS ---
        async function togglePinComment(movieId, episodeId, commentId, isCurrentlyPinned) {
            if (!db) return;
            const newPinStatus = !isCurrentlyPinned;
            showLoader(true);
            try {
                const commentRef = ref(db, `comments/${movieId}/${episodeId}/${commentId}`);
                await update(commentRef, { isPinned: newPinStatus });
                // The table will reload and re-render correctly
                loadMovieReviews();
            } catch (error) {
                console.error("Error pinning comment:", error);
                showStatus(elements.movieReviewsStatus, `Error: ${error.message}`, "danger");
            } finally {
                showLoader(false);
            }
        }
        async function openReplyModal(movieId, episodeId, commentId) {
            if (!db) return;
            // Find the comment text from the DOM
            const parentCommentRow = document.querySelector(`button.btn-delete-review[data-comment-id="${commentId}"]`).closest('tr');
            const parentText = parentCommentRow ? parentCommentRow.querySelector('.wrap-text').textContent.replace('Pinned','').trim() : '...';

            elements.replyForm.reset();
            clearStatus(elements.replyStatus);
            elements.replyMovieId.value = movieId;
            elements.replyEpisodeId.value = episodeId;
            elements.replyCommentId.value = commentId;
            elements.parentCommentText.textContent = parentText;

            getModalInstance(elements.replyModalEl)?.show();
        }
        async function saveReply() {
            if (!db) return;
            const movieId = elements.replyMovieId.value;
            const episodeId = elements.replyEpisodeId.value;
            const commentId = elements.replyCommentId.value;
            const replyText = elements.replyText.value.trim();

            if (!replyText || !movieId || !episodeId || !commentId) {
                showStatus(elements.replyStatus, "Reply text cannot be empty.", "warning");
                return;
            }

            const replyData = {
                text: replyText,
                timestamp: serverTimestamp(),
                author: 'Admin',
                authorId: currentAdminUser.uid
            };
            
            showLoader(true);
            try {
                const repliesRef = ref(db, `comments/${movieId}/${episodeId}/${commentId}/replies`);
                await push(repliesRef, replyData);
                getModalInstance(elements.replyModalEl)?.hide();
                loadMovieReviews(); // Refresh the view
            } catch(error) {
                showStatus(elements.replyStatus, `Error: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
            }
        }
        async function deleteReply(movieId, episodeId, commentId, replyId) {
            if (!db || !replyId || !confirm('Are you sure you want to delete this admin reply?')) return;
            showLoader(true);
            try {
                const replyRef = ref(db, `comments/${movieId}/${episodeId}/${commentId}/replies/${replyId}`);
                await remove(replyRef);
                showStatus(elements.movieReviewsStatus, "Reply deleted successfully.", "success");
                loadMovieReviews();
            } catch (error) {
                console.error("Error deleting reply:", error);
                showStatus(elements.movieReviewsStatus, `Error: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
            }
        }

        // --- File Upload Functions ---
        async function uploadToImgBB(file, statusElement) { if (!file) throw new Error("File not selected."); if (!IMGBB_API_KEY || IMGBB_API_KEY === 'YOUR_IMGBB_API_KEY') { throw new Error("ImgBB API Key not set."); } const formData = new FormData(); formData.append('image', file); if (statusElement) statusElement.textContent = 'Uploading...'; try { const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData }); const data = await response.json(); if (data.success) return data.data.url; else throw new Error(data.error?.message || 'Unknown error'); } catch (error) { if (statusElement) statusElement.textContent = `Upload Error: ${error.message}`; throw error; } }
        async function uploadVideoToFirebaseStorage(file, movieId, seasonId, episodeId, statusElement) {
            if (!file) throw new Error("Video file not provided.");
            if (!storage) throw new Error("Firebase Storage is not initialized.");
            
            const videoRef = storageRef(storage, `movies/${movieId}/seasons/${seasonId}/${episodeId}_${file.name}`);
            if (statusElement) statusElement.textContent = `Uploading video...`;

            try {
                const snapshot = await uploadBytes(videoRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                if (statusElement) statusElement.textContent = `Upload complete.`;
                return downloadURL;
            } catch (error) {
                if (statusElement) statusElement.textContent = `Upload error: ${error.message}`;
                throw error;
            }
        }


        // --- Database Save/Update/Delete Functions ---
        async function saveGame() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const gameId = elements.gameEditId.value; const isEditing = !!gameId;
            const name = elements.gameNameInput.value.trim();
            const imageUrlInput = elements.gameImageUrlInput.value.trim();
            const imageFile = elements.gameImageFileInput.files[0];
            if (!name || (!imageUrlInput && !imageFile && !isEditing)) { showStatus(elements.gameStatus, "Name and Image required.", "warning"); return; }
            showLoader(true);
            try {
                let finalImageUrl = imageUrlInput;
                if (imageFile) finalImageUrl = await uploadToImgBB(imageFile, elements.gameForm.querySelector('.imgbb-upload-status'));
                const gameData = { name: name, imageUrl: finalImageUrl, updatedAt: serverTimestamp() };
                if (isEditing) {
                    await update(ref(db, `games/${gameId}`), gameData);
                } else {
                    gameData.createdAt = serverTimestamp();
                    await push(ref(db, 'games'), gameData);
                }
                getModalInstance(elements.gameModalEl)?.hide();
                loadGames();
            } catch (error) { showStatus(elements.gameStatus, `Error: ${error.message}`, "danger", false); } finally { showLoader(false); }
        }
        async function saveMovie() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const statusEl = elements.movieStatus;
            clearStatus(statusEl);

            let movieId = elements.movieEditId.value;
            const isEditing = !!movieId;
            if (!isEditing) {
                movieId = push(ref(db, 'movies')).key;
            }

            const name = elements.movieNameInput.value.trim();
            const imageUrl = elements.movieImageUrlInput.value.trim();
            const releaseDate = elements.movieReleaseDateInput.value;
            const categoryId = elements.movieCategoryIdSelect.value;
            const tags = elements.movieTagsInput.value.split(',').map(tag => tag.trim()).filter(Boolean);
            const story = elements.movieStoryInput.value.trim();
            const trailerName = elements.movieTrailerNameInput.value.trim();
            const trailerUrl = elements.movieTrailerUrlInput.value.trim();
            const access = elements.movieAccessSelect.value;
            const language = elements.movieLanguageInput.value.trim();
            const rating = parseFloat(elements.movieRatingInput.value) || 0;

            if (!name || !imageUrl || !categoryId) {
                showStatus(statusEl, "Name, Image, and Category are required.", "warning");
                return;
            }

            showLoader(true);
            try {
                const seasons = {};
                const seasonItems = elements.seasonsContainer.querySelectorAll('.season-item');
                const uploadPromises = [];

                for (let i = 0; i < seasonItems.length; i++) {
                    const seasonItem = seasonItems[i];
                    const seasonTitle = seasonItem.querySelector('.season-title').value.trim();
                    if (!seasonTitle) throw new Error(`Title for Season #${i+1} is required.`);
                    if (seasons[seasonTitle]) throw new Error(`Duplicate season title found: "${seasonTitle}". Please use unique titles.`);
                    
                    const seasonId = `season_${i + 1}`;
                    seasons[seasonTitle] = { episodes: {} };

                    const episodeItems = seasonItem.querySelectorAll('.episode-item');
                    for (let j = 0; j < episodeItems.length; j++) {
                        const episodeItem = episodeItems[j];
                        const episodeId = `ep_${Date.now()}_${i}_${j}`;
                        
                        const title = episodeItem.querySelector('.episode-title').value.trim();
                        const quality = episodeItem.querySelector('.episode-quality').value;
                        let playUrl = episodeItem.querySelector('.episode-play-url').value.trim();
                        const downloadUrl = episodeItem.querySelector('.episode-download-url').value.trim();
                        const videoFile = episodeItem.querySelector('.episode-video-file').files[0];
                        const statusDiv = episodeItem.querySelector('.video-upload-status');

                        if (!title || !quality || (!playUrl && !videoFile) || !downloadUrl) {
                            throw new Error(`All fields for Episode ${j + 1} in ${seasonTitle} are required.`);
                        }

                        const episodeData = { title, quality, downloadUrl, playUrl };
                        seasons[seasonTitle].episodes[episodeId] = episodeData;

                        if (videoFile) {
                            const uploadPromise = uploadVideoToFirebaseStorage(videoFile, movieId, seasonId, episodeId, statusDiv)
                                .then(downloadURL => {
                                    seasons[seasonTitle].episodes[episodeId].playUrl = downloadURL; 
                                });
                            uploadPromises.push(uploadPromise);
                        }
                    }
                }

                await Promise.all(uploadPromises);

                const movieData = { 
                    name, imageUrl, releaseDate, categoryId, tags, story, 
                    trailerName, trailerUrl, seasons, 
                    access, language, rating, // NEW FIELDS ADDED
                    updatedAt: serverTimestamp() 
                };
                
                // Clear old episodes node if it exists
                movieData.episodes = null;

                if (isEditing) {
                    await update(ref(db, `movies/${movieId}`), movieData);
                } else {
                    movieData.createdAt = serverTimestamp();
                    await set(ref(db, `movies/${movieId}`), movieData);
                }
                
                getModalInstance(elements.movieModalEl)?.hide();
                loadMovies();
                loadDashboardStats();
            } catch (error) {
                showStatus(statusEl, `Error: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
            }
        }
        async function saveMovieCategory() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const categoryId = elements.movieCategoryEditId.value;
            const isEditing = !!categoryId;
            const name = elements.movieCategoryNameInput.value.trim();
            const imageUrlInput = elements.movieCategoryImageUrlInput.value.trim();
            const imageFile = elements.movieCategoryImageFileInput.files[0];

            if (!name || (!imageUrlInput && !imageFile && !isEditing)) {
                showStatus(elements.movieCategoryStatus, "Category Name and Image are required.", "warning");
                return;
            }
            showLoader(true);
            try {
                let finalImageUrl = imageUrlInput;
                if (imageFile) {
                    finalImageUrl = await uploadToImgBB(imageFile, elements.movieCategoryForm.querySelector('.imgbb-upload-status'));
                }

                const categoryData = { name, imageUrl: finalImageUrl, updatedAt: serverTimestamp() };
                if (isEditing) {
                    await update(ref(db, `movieCategories/${categoryId}`), categoryData);
                } else {
                    categoryData.createdAt = serverTimestamp();
                    await push(ref(db, 'movieCategories'), categoryData);
                }
                getModalInstance(elements.movieCategoryModalEl)?.hide();
                loadMovieCategories();
            } catch (error) {
                showStatus(elements.movieCategoryStatus, `Error: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
            }
        }
        async function savePromotion() {
             if (!db || !isDesignatedAdmin(currentAdminUser)) return;
             const promoId = elements.promotionEditId.value; const isEditing = !!promoId;
             const link = elements.promoLinkInput.value.trim();
             const imageUrl = elements.promoImageUrlInput.value.trim();
             const imageFile = elements.promoImageFileInput.files[0];
             if (!imageUrl && !imageFile) { showStatus(elements.promotionStatus, "Image required.", "warning"); return; }
             showLoader(true);
             try {
                let finalImageUrl = imageUrl;
                if(imageFile) finalImageUrl = await uploadToImgBB(imageFile, elements.promotionForm.querySelector('.imgbb-upload-status'));
                const promoData = { imageUrl: finalImageUrl, link: link, updatedAt: serverTimestamp() };
                if(isEditing) await update(ref(db, `promotions/${promoId}`), promoData);
                else { promoData.createdAt = serverTimestamp(); await push(ref(db, 'promotions'), promoData); }
                getModalInstance(elements.promotionModalEl)?.hide(); loadPromotions();
             } catch(e) { showStatus(elements.promotionStatus, `Error: ${e.message}`, 'danger', false); } finally { showLoader(false); }
        }
        async function saveMoviePromotion() {
             if (!db || !isDesignatedAdmin(currentAdminUser)) return;
             const promoId = elements.moviePromotionEditId.value; const isEditing = !!promoId;
             const link = elements.moviePromoLinkInput.value.trim();
             const imageUrl = elements.moviePromoImageUrlInput.value.trim();
             const imageFile = elements.moviePromoImageFileInput.files[0];
             if (!imageUrl && !imageFile) { showStatus(elements.moviePromotionStatus, "Image required.", "warning"); return; }
             showLoader(true);
             try {
                let finalImageUrl = imageUrl;
                if(imageFile) finalImageUrl = await uploadToImgBB(imageFile, elements.moviePromotionForm.querySelector('.imgbb-upload-status'));
                const promoData = { imageUrl: finalImageUrl, link: link, updatedAt: serverTimestamp() };
                if(isEditing) await update(ref(db, `moviePromotions/${promoId}`), promoData);
                else { promoData.createdAt = serverTimestamp(); await push(ref(db, 'moviePromotions'), promoData); }
                getModalInstance(elements.moviePromotionModalEl)?.hide(); loadMoviePromotions();
             } catch(e) { showStatus(elements.moviePromotionStatus, `Error: ${e.message}`, 'danger', false); } finally { showLoader(false); }
        }
        async function saveTournament(event) {
            event.preventDefault();
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const statusEl = elements.addTournamentStatus;
            clearStatus(statusEl);
            try {
                const startTime = new Date(elements.tournamentStartTimeInput.value).getTime();
                if(isNaN(startTime)) throw new Error("Invalid start time");
                const tournamentData = {
                    gameId: elements.tournamentGameSelect.value, name: elements.tournamentNameInput.value.trim(),
                    startTime: startTime, status: elements.tournamentStatusSelect.value,
                    entryFee: parseFloat(elements.tournamentEntryFeeInput.value) || 0,
                    prizePool: parseFloat(elements.tournamentPrizePoolInput.value) || 0,
                    perKillPrize: parseFloat(elements.tournamentPerKillInput.value) || 0,
                    maxPlayers: parseInt(elements.tournamentMaxPlayersInput.value) || 0,
                    tags: elements.tournamentTagsInput.value.split(',').map(t=>t.trim()),
                    imageUrl: elements.tournamentImageUrlInput.value.trim(), videoUrl: elements.tournamentVideoUrlInput.value.trim(),
                    facebookUrl: elements.tournamentFacebookUrlInput.value.trim(), instagramUrl: elements.tournamentInstagramUrlInput.value.trim(),
                    tiktokUrl: elements.tournamentTiktokUrlInput.value.trim(), description: elements.tournamentDescriptionInput.value.trim(),
                    roomId: elements.tournamentRoomIdInput.value.trim(), roomPassword: elements.tournamentRoomPasswordInput.value.trim(),
                    showIdPass: elements.tournamentShowIdPassCheckbox.checked, updatedAt: serverTimestamp()
                };
                showLoader(true);
                if (currentEditingTournamentId) {
                    await update(ref(db, `tournaments/${currentEditingTournamentId}`), tournamentData);
                } else {
                    tournamentData.createdAt = serverTimestamp();
                    await push(ref(db, 'tournaments'), tournamentData);
                }
                getModalInstance(elements.addTournamentModalEl)?.hide();
                loadTournaments(); loadDashboardStats();
            } catch (error) { showStatus(statusEl, `Error: ${error.message}`, "danger", false); } finally { showLoader(false); }
        }
        async function deleteGame(gameId) { if (!db || !gameId || !confirm('Delete game?')) return; showLoader(true); try { await remove(ref(db, `games/${gameId}`)); loadGames(); } catch (e) { alert(e.message); } finally { showLoader(false); } }
        async function deleteMovie(movieId) { if (!db || !movieId || !confirm('Delete movie? This cannot be undone.')) return; showLoader(true); try { await remove(ref(db, `movies/${movieId}`)); loadMovies(); loadDashboardStats(); } catch (e) { alert(`Error deleting movie: ${e.message}`); } finally { showLoader(false); } }
        async function deleteMovieCategory(categoryId) {
            if (!db || !categoryId || !confirm('Delete movie category? This cannot be undone.')) return;
            showLoader(true);
            try {
                await remove(ref(db, `movieCategories/${categoryId}`));
                loadMovieCategories();
            } catch (e) {
                alert(`Error deleting movie category: ${e.message}`);
            } finally {
                showLoader(false);
            }
        }
        async function deletePromotion(promoId) { if (!db || !promoId || !confirm('Delete app promotion?')) return; showLoader(true); try { await remove(ref(db, `promotions/${promoId}`)); loadPromotions(); } catch (e) { alert(e.message); } finally { showLoader(false); } }
        async function deleteMoviePromotion(promoId) { if (!db || !promoId || !confirm('Delete movie promotion?')) return; showLoader(true); try { await remove(ref(db, `moviePromotions/${promoId}`)); loadMoviePromotions(); } catch (e) { alert(e.message); } finally { showLoader(false); } }
        async function deleteTournament(tId) { if (!db || !tId || !confirm('Delete tournament?')) return; showLoader(true); try { await remove(ref(db, `tournaments/${tId}`)); loadTournaments(); } catch (e) { alert(e.message); } finally { showLoader(false); } }
        async function saveNewUser() {
            if(!auth || !db) return;
            const name = elements.newUserNameInput.value.trim(), email = elements.newUserEmailInput.value.trim(), pass = elements.newUserPasswordInput.value, bal = parseFloat(elements.newUserInitialBalanceInput.value) || 0;
            if(!name || !email || pass.length < 6) { showStatus(elements.addUserStatus, 'All fields required, pass min 6 chars', 'warning'); return; }
            showLoader(true);
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const uid = cred.user.uid;
                const userData = { uid, email, displayName: name, balance: bal, winningCash: 0, bonusCash: 0, status: 'active', createdAt: serverTimestamp(), referralCode: Math.random().toString(36).substring(2,10).toUpperCase(), totalEarnings: 0, totalMatches: 0, wonMatches: 0 };
                await set(ref(db, `users/${uid}`), userData);
                getModalInstance(elements.addUserModalEl)?.hide();
                loadDashboardStats();
            } catch(e) { showStatus(elements.addUserStatus, `Error: ${e.message}`, 'danger', false); } finally { showLoader(false); }
        }
        async function updateUserBalance(event) {
            event.preventDefault(); if(!db) return;
            const uid = elements.editUserUid.value, amount = parseFloat(elements.balanceUpdateAmountInput.value), type = elements.balanceUpdateTypeSelect.value, reason = elements.balanceUpdateReasonInput.value.trim();
            if(!uid || !amount || !type || !reason) { showStatus(elements.balanceUpdateStatus, 'All fields required', 'warning'); return; }
            showLoader(true);
            try {
                const userRef = ref(db, `users/${uid}`);
                const snap = await get(userRef);
                if(!snap.exists()) throw new Error('User not found');
                const user = snap.val();
                let { balance, winningCash, bonusCash } = user;
                balance = balance || 0; winningCash = winningCash || 0; bonusCash = bonusCash || 0;
                let updates = {}; let logType = '';
                if(type === 'balance') { balance += amount; updates.balance = balance; logType = 'admin_deposit'; }
                else if (type === 'winningCash') { winningCash += amount; balance += amount; updates.winningCash = winningCash; updates.balance = balance; logType = 'admin_winning_add'; }
                else if (type === 'bonusCash') { bonusCash += amount; balance += amount; updates.bonusCash = bonusCash; updates.balance = balance; logType = 'admin_bonus_add'; }
                if(balance < 0 && !confirm('Negative balance. Proceed?')) { showLoader(false); return; }
                await update(userRef, updates);
                const txData = { type: logType, amount, timestamp: serverTimestamp(), description: `Admin: ${reason}`, balanceAfter: balance };
                await push(ref(db, `transactions/${uid}`), txData);
                elements.userDetailBalance.textContent = balance.toFixed(2);
                elements.userDetailWinning.textContent = winningCash.toFixed(2);
                elements.userDetailBonus.textContent = bonusCash.toFixed(2);
                showStatus(elements.balanceUpdateStatus, 'Balance updated!', 'success');
            } catch(e) { showStatus(elements.balanceUpdateStatus, `Error: ${e.message}`, 'danger'); } finally { showLoader(false); }
        }
        async function toggleUserBlock(event) {
            const btn = event.target.closest('button'); if(!db || !btn) return;
            const uid = btn.dataset.id, action = btn.dataset.action;
            const newStatus = action === 'block' ? 'blocked' : 'active';
            if(!confirm(`Confirm ${action} user?`)) return;
            showLoader(true);
            try {
                await set(ref(db, `users/${uid}/status`), newStatus);
                // No need to call filterUsers, the realtime listener will update the table.
                // Manually update the modal if it's open
                if(getModalInstance(elements.userModalEl)?._isShown && elements.editUserUid.value === uid) {
                     elements.userDetailStatus.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                     elements.userDetailStatus.className = `fw-bold text-${newStatus === 'active' ? 'success' : 'danger'}`;
                     btn.textContent = newStatus === 'active' ? 'Block User' : 'Unblock User';
                     btn.className = `btn btn-sm ${newStatus === 'active' ? 'btn-danger' : 'success'}`;
                     btn.dataset.action = newStatus === 'active' ? 'block' : 'unblock';
                }
            } catch(e) { alert(e.message); } finally { showLoader(false); }
        }
        async function deleteUser(userId) { if (!db || !userId || !confirm('DELETE USER from DB only? Auth user remains. Cannot be undone.')) return; showLoader(true); try { await remove(ref(db, `users/${userId}`)); getModalInstance(elements.userModalEl)?.hide(); loadDashboardStats(); } catch(e) { alert(e.message); } finally { showLoader(false); } }
        async function openWithdrawalActionModal(withdrawalId, type) {
            if(!db) return;
            showLoader(true);
            try {
                const wSnap = await get(ref(db, `withdrawals/${withdrawalId}`));
                if(!wSnap.exists()) throw new Error('Withdrawal not found');
                const w = wSnap.val();
                if(w.status !== 'pending') { alert('Already processed.'); return; }
                currentWithdrawalAction = { id: withdrawalId, type: type, userId: w.userId };
                const uSnap = await get(ref(db, `users/${w.userId}`));
                const user = uSnap.exists() ? uSnap.val() : {};
                getElement('withdrawalDetailId').textContent = withdrawalId;
                getElement('withdrawalDetailUser').textContent = `${user.displayName} (${user.email})`;
                getElement('withdrawalDetailUserUid').textContent = w.userId;
                getElement('withdrawalDetailAmount').textContent = w.amount;
                getElement('withdrawalDetailMethod').textContent = `${w.methodDetails?.methodName} - ${w.methodDetails?.accountInfo}`;
                getElement('withdrawalRejectReasonDiv').style.display = type === 'reject' ? 'block' : 'none';
                getElement('withdrawalApproveNoteDiv').style.display = type === 'approve' ? 'block' : 'none';
                getElement('approveWithdrawalBtn').style.display = type === 'approve' ? 'block' : 'none';
                getElement('rejectWithdrawalBtn').style.display = type === 'reject' ? 'block' : 'none';
                getModalInstance(elements.withdrawalActionModalEl)?.show();
            } catch(e) { alert(e.message); } finally { showLoader(false); }
        }
        async function processWithdrawalAction() {
            const { id, type, userId } = currentWithdrawalAction;
            if(!db || !id || !type || !userId) return;
            showLoader(true);
            try {
                const wRef = ref(db, `withdrawals/${id}`);
                const wSnap = await get(wRef);
                if(!wSnap.exists() || wSnap.val().status !== 'pending') throw new Error('Request invalid or processed');
                const amount = wSnap.val().amount;
                const updates = {};
                if(type === 'reject') {
                    const reason = elements.withdrawalRejectReasonInput.value.trim();
                    if(!reason) throw new Error('Reason required');
                    updates[`withdrawals/${id}/status`] = 'rejected';
                    updates[`withdrawals/${id}/rejectReason`] = reason;
                    updates[`withdrawals/${id}/processedAt`] = serverTimestamp();
                    // Refund
                    const uSnap = await get(ref(db, `users/${userId}`));
                    const u = uSnap.val();
                    updates[`users/${userId}/balance`] = (u.balance || 0) + amount;
                    updates[`users/${userId}/winningCash`] = (u.winningCash || 0) + amount;
                    const txRefund = { type: 'withdrawal_refund', amount, timestamp: serverTimestamp(), description: `Refund: ${reason}` };
                    updates[`transactions/${userId}/${push(ref(db,`transactions/${userId}`)).key}`] = txRefund;
                } else {
                    updates[`withdrawals/${id}/status`] = 'completed';
                    updates[`withdrawals/${id}/adminNote`] = elements.withdrawalApproveNoteInput.value.trim();
                    updates[`withdrawals/${id}/processedAt`] = serverTimestamp();
                }
                await update(ref(db), updates);
                getModalInstance(elements.withdrawalActionModalEl)?.hide();
                loadDashboardStats();
            } catch(e) { showStatus(elements.withdrawalActionStatus, `Error: ${e.message}`, 'danger'); } finally { showLoader(false); }
        }
        async function saveSettings(event) {
            event.preventDefault(); 
            if(!db) return;
            try {
                const settingsData = {
                    logoUrl: getElement('settingLogoUrl').value, 
                    appName: getElement('settingAppName').value,
                    minWithdraw: parseFloat(getElement('settingMinWithdraw').value) || 0,
                    referralBonus: parseFloat(getElement('settingReferralBonus').value) || 0,
                    supportContact: getElement('settingSupportContact').value, 
                    upiDetails: getElement('settingUpiDetails').value,
                    policyPrivacy: getElement('settingPolicyPrivacy').value, 
                    policyTerms: getElement('settingPolicyTerms').value,
                    policyRefund: getElement('settingPolicyRefund').value, 
                    policyFairPlay: getElement('settingPolicyFairPlay').value,
                    lastUpdated: serverTimestamp()
                };
                await set(ref(db, 'settings'), settingsData);
                showStatus(elements.settingsStatus, 'Settings saved!', 'success');
                loadSettings();
            } catch(e) { 
                showStatus(elements.settingsStatus, `Error: ${e.message}`, 'danger', false); 
            }
        }
        async function changeAdminPassword(event) {
            event.preventDefault();
            if (!auth || !currentAdminUser) return;
            const curPass = getElement('currentPassword').value, newPass = getElement('newPassword').value, confPass = getElement('confirmNewPassword').value;
            if(!curPass || newPass.length < 6 || newPass !== confPass) { showStatus(elements.changePasswordStatus, 'Check inputs', 'warning'); return;}
            showLoader(true);
            try {
                const cred = EmailAuthProvider.credential(auth.currentUser.email, curPass);
                await reauthenticateWithCredential(auth.currentUser, cred);
                await updatePassword(auth.currentUser, newPass);
                showStatus(elements.changePasswordStatus, 'Password changed!', 'success');
                elements.changePasswordForm.reset();
            } catch(e) { showStatus(elements.changePasswordStatus, `Error: ${e.code}`, 'danger', false); } finally { showLoader(false); }
        }
        async function loadThemeSettings() { if(!db) return; try{ const snap = await get(ref(db, 'settings/theme')); populateThemePickers(snap.exists() ? snap.val() : defaultTheme); } catch(e){ populateThemePickers(defaultTheme); } }
        function populateThemePickers(theme) { elements.themeColorPickers.forEach(p => { const cssVar = p.dataset.var; p.value = theme[cssVar] || '#000000'; p.parentElement.querySelector('input[type="text"]').value = p.value; }); }
        async function saveTheme() { if(!db) return; const themeData = {}; elements.themeColorPickers.forEach(p => { if(/^#[0-9A-F]{6}$/i.test(p.value)) themeData[p.dataset.var] = p.value; }); showLoader(true); try{ await update(ref(db, 'settings'), { theme: themeData }); showStatus(elements.themeStatus, 'Theme saved!', 'success'); } catch(e) { showStatus(elements.themeStatus, `Error: ${e.message}`, 'danger'); } finally { showLoader(false); } }
        async function resetTheme() { if(!db || !confirm('Reset to default theme?')) return; showLoader(true); try { await remove(ref(db, 'settings/theme')); populateThemePickers(defaultTheme); showStatus(elements.themeStatus, 'Theme reset!', 'success'); } catch(e) { showStatus(elements.themeStatus, `Error: ${e.message}`, 'danger'); } finally { showLoader(false); } }

        // --- Realtime Listeners ---
        function setupRealtimeAdminListeners() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            detachAllAdminListeners();
            const pendingQuery = query(ref(db, 'withdrawals'), orderByChild('status'), equalTo('pending'));
            const countKey = 'pendingWithdrawalsCount';
            dbListeners[countKey] = onValue(pendingQuery, (snapshot) => {
                 const count = snapshot.exists() ? snapshot.size : 0;
                 elements.pendingWithdrawalCountBadge.textContent = count;
                 elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none';
                 if (elements.dashboardSection?.classList.contains('active')) elements.statPendingWithdrawals.textContent = count;
            });
        }
        function detachAllAdminListeners() { if (!db || Object.keys(dbListeners).length === 0) return; Object.keys(dbListeners).forEach(key => { try { if (key === 'pendingWithdrawalsCount') off(query(ref(db, 'withdrawals'), orderByChild('status'), equalTo('pending')), 'value', dbListeners[key]); else if (key === 'users') off(ref(db, 'users'), 'value', dbListeners[key]); } catch (e) {} }); dbListeners = {}; }

        // --- Season & Episode Management ---
        function createEpisodeItem(episode = {}) {
            const episodeId = `ep-dom-${Date.now()}_${Math.random()}`;
            const div = document.createElement('div');
            div.className = 'episode-item';
            div.id = episodeId;
            div.innerHTML = `
                <div class="episode-item-header">
                    <h6 class="mb-0 text-secondary">New Episode</h6>
                    <button type="button" class="btn-close btn-close-white" aria-label="Remove"></button>
                </div>
                <div class="row g-2">
                    <div class="col-md-8">
                        <label class="form-label form-label-sm">Episode Title</label>
                        <input type="text" class="form-control form-control-sm episode-title" required value="${sanitizeHTML(episode.title || '')}">
                    </div>
                    <div class="col-md-4">
                         <label class="form-label form-label-sm">Quality</label>
                         <select class="form-select form-select-sm episode-quality" required>
                            <option value="">-- Quality --</option>
                            <option value="1080p" ${episode.quality === '1080p' ? 'selected' : ''}>1080p</option>
                            <option value="720p" ${episode.quality === '720p' ? 'selected' : ''}>720p</option>
                            <option value="480p" ${episode.quality === '480p' ? 'selected' : ''}>480p</option>
                         </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label form-label-sm">Play URL (or Upload File)</label>
                        <input type="url" class="form-control form-control-sm episode-play-url" value="${sanitizeHTML(episode.playUrl || '')}">
                    </div>
                    <div class="col-12">
                        <label class="form-label form-label-sm">Upload Video File (Overrides Play URL)</label>
                        <input type="file" class="form-control form-control-sm episode-video-file" accept="video/*">
                        <div class="video-upload-status small text-muted mt-1"></div>
                    </div>
                    <div class="col-12">
                        <label class="form-label form-label-sm">Download URL</label>
                        <input type="url" class="form-control form-control-sm episode-download-url" required value="${sanitizeHTML(episode.downloadUrl || '')}">
                    </div>
                </div>
            `;
            div.querySelector('.btn-close').addEventListener('click', () => div.remove());
            return div;
        }

        function createSeasonItem(seasonTitle = '', episodes = {}) {
            const seasonId = `season-dom-${Date.now()}_${Math.random()}`;
            const div = document.createElement('div');
            div.className = 'season-item card bg-dark mb-3';
            div.id = seasonId;
            div.innerHTML = `
                <div class="card-header d-flex justify-content-between align-items-center">
                    <input type="text" class="form-control form-control-sm season-title" placeholder="e.g., Season 1" required value="${sanitizeHTML(seasonTitle)}">
                    <button type="button" class="btn-close btn-close-white ms-2" aria-label="Remove Season"></button>
                </div>
                <div class="card-body">
                    <div class="episodes-container-for-season">
                        <!-- Episodes for this season will be added here -->
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-success btn-add-episode-to-season mt-2"><i class="bi bi-plus-circle"></i> Add Episode to this Season</button>
                </div>
            `;
            const episodesContainer = div.querySelector('.episodes-container-for-season');
            Object.values(episodes).forEach(ep => episodesContainer.appendChild(createEpisodeItem(ep)));

            div.querySelector('.btn-close').addEventListener('click', () => div.remove());
            div.querySelector('.btn-add-episode-to-season').addEventListener('click', () => {
                episodesContainer.appendChild(createEpisodeItem());
            });
            return div;
        }

        function addSeason() {
            elements.seasonsContainer.appendChild(createSeasonItem());
        }


        // --- Modal & Event Handlers ---
        async function populateGameSelect(selectedValue = null) { const select = elements.tournamentGameSelect; select.innerHTML = '<option value="">Loading...</option>'; try { if (Object.keys(gameDataCache).length === 0) await loadGames(); select.innerHTML = '<option value="">-- Select Game --</option>'; Object.entries(gameDataCache).forEach(([id, name]) => { const opt = document.createElement('option'); opt.value = id; opt.textContent = name; select.appendChild(opt); }); if (selectedValue) select.value = selectedValue; } catch (e) { select.innerHTML = '<option value="">Error</option>'; } }
        async function populateMovieCategorySelect(selectedValue = null) { const select = elements.movieCategoryIdSelect; select.innerHTML = '<option value="">Loading...</option>'; try { if (Object.keys(movieCategoryCache).length === 0) await loadMovieCategories(); select.innerHTML = '<option value="">-- Select Category --</option>'; Object.entries(movieCategoryCache).forEach(([id, name]) => { const opt = document.createElement('option'); opt.value = id; opt.textContent = name; select.appendChild(opt); }); if (selectedValue) select.value = selectedValue; } catch (e) { select.innerHTML = '<option value="">Error loading categories</option>'; } }
        
        async function openEditGameModal(gameId) {
            if (!db) return;
            showLoader(true);
            try {
                const snapshot = await get(ref(db, `games/${gameId}`));
                if (!snapshot.exists()) throw new Error('Game not found');
                const game = snapshot.val();
                elements.gameForm.reset();
                elements.gameEditId.value = gameId;
                elements.gameNameInput.value = game.name || '';
                elements.gameImageUrlInput.value = game.imageUrl || '';
                elements.gameModalTitle.textContent = "Edit Game";
                getModalInstance(elements.gameModalEl)?.show();
            } catch (e) {
                alert(e.message);
            } finally {
                showLoader(false);
            }
        }
        
        async function openEditPromotionModal(promoId) {
            if (!db) return;
            showLoader(true);
            try {
                const snapshot = await get(ref(db, `promotions/${promoId}`));
                if (!snapshot.exists()) throw new Error('Promotion not found');
                const promo = snapshot.val();
                elements.promotionForm.reset();
                elements.promotionEditId.value = promoId;
                elements.promoImageUrlInput.value = promo.imageUrl || '';
                elements.promoLinkInput.value = promo.link || '';
                elements.promotionModalTitle.textContent = "Edit App Promotion";
                getModalInstance(elements.promotionModalEl)?.show();
            } catch (e) {
                alert(e.message);
            } finally {
                showLoader(false);
            }
        }
        async function openEditMoviePromotionModal(promoId) {
            if(!db) return;
            showLoader(true);
            try {
                const snapshot = await get(ref(db, `moviePromotions/${promoId}`));
                if (!snapshot.exists()) throw new Error('Movie promotion not found');
                const promo = snapshot.val();
                elements.moviePromotionForm.reset();
                elements.moviePromotionEditId.value = promoId;
                elements.moviePromoImageUrlInput.value = promo.imageUrl || '';
                elements.moviePromoLinkInput.value = promo.link || '';
                elements.moviePromotionModalTitle.textContent = "Edit Movie Promotion";
                getModalInstance(elements.moviePromotionModalEl)?.show();
            } catch(e) {
                alert(e.message);
            } finally {
                showLoader(false);
            }
        }
        async function openEditMovieModal(movieId) {
            if (!db) return;
            showLoader(true);
            try {
                const movie = moviesDataCache[movieId];
                if (!movie) throw new Error('Movie not found');
                
                elements.movieForm.reset();
                elements.seasonsContainer.innerHTML = '';
                await populateMovieCategorySelect(movie.categoryId);

                elements.movieEditId.value = movieId;
                elements.movieNameInput.value = movie.name || '';
                elements.movieImageUrlInput.value = movie.imageUrl || '';
                elements.movieReleaseDateInput.value = movie.releaseDate || '';
                elements.movieTagsInput.value = (movie.tags || []).join(', ');
                elements.movieStoryInput.value = movie.story || '';
                elements.movieTrailerNameInput.value = movie.trailerName || '';
                elements.movieTrailerUrlInput.value = movie.trailerUrl || '';
                elements.movieAccessSelect.value = movie.access || 'Free'; // NEW
                elements.movieLanguageInput.value = movie.language || ''; // NEW
                elements.movieRatingInput.value = movie.rating || ''; // NEW
                
                if (movie.seasons) {
                    Object.entries(movie.seasons).forEach(([seasonTitle, seasonData]) => {
                        elements.seasonsContainer.appendChild(createSeasonItem(seasonTitle, seasonData.episodes));
                    });
                }

                elements.movieModalTitle.textContent = "Edit Movie";
                getModalInstance(elements.movieModalEl)?.show();
            } catch (e) {
                alert(e.message);
            } finally {
                showLoader(false);
            }
        }
        async function openEditMovieCategoryModal(categoryId) {
            if (!db) return;
            showLoader(true);
            try {
                const snapshot = await get(ref(db, `movieCategories/${categoryId}`));
                if (!snapshot.exists()) throw new Error('Movie category not found');
                const category = snapshot.val();
                elements.movieCategoryForm.reset();
                elements.movieCategoryEditId.value = categoryId;
                elements.movieCategoryNameInput.value = category.name || '';
                elements.movieCategoryImageUrlInput.value = category.imageUrl || '';
                elements.movieCategoryModalTitle.textContent = "Edit Movie Category";
                getModalInstance(elements.movieCategoryModalEl)?.show();
            } catch (e) {
                alert(e.message);
            } finally {
                showLoader(false);
            }
        }
        async function openEditTournamentModal(tId) { if(!db) return; showLoader(true); try{ const snap = await get(ref(db, `tournaments/${tId}`)); if(!snap.exists()) throw new Error('Tournament not found'); const t = snap.val(); await populateGameSelect(t.gameId); currentEditingTournamentId = tId; elements.tournamentModalTitle.textContent = "Edit Tournament"; /* ... populate all fields ... */ getModalInstance(elements.addTournamentModalEl)?.show(); } catch(e) { alert(e.message); } finally { showLoader(false); } }
        async function openUserModal(userId) {
            if(!db) return; showLoader(true);
            try{
                const user = fullUserDataCache[userId] || (await get(ref(db, `users/${userId}`))).val();
                if(!user) throw new Error('User not found');
                
                elements.userModalTitle.textContent = `User: ${user.displayName || 'N/A'}`;
                elements.userDetailUid.textContent = userId;
                elements.userDetailEmail.textContent = user.email || 'N/A';
                elements.userDetailName.textContent = user.displayName || 'N/A';
                elements.userDetailCreatedAt.textContent = formatDate(user.createdAt);
                elements.userDetailBalance.textContent = (user.balance || 0).toFixed(2);
                elements.userDetailWinning.textContent = (user.winningCash || 0).toFixed(2);
                elements.userDetailBonus.textContent = (user.bonusCash || 0).toFixed(2);
                elements.editUserUid.value = userId;
                elements.userDetailReferralCode.textContent = user.referralCode || 'N/A';
                
                const status = user.status || 'active';
                elements.userDetailStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                elements.userDetailStatus.className = `fw-bold text-${status === 'active' ? 'success' : 'danger'}`;
                elements.userBlockBtn.textContent = status === 'active' ? 'Block User' : 'Unblock User';
                elements.userBlockBtn.className = `btn btn-sm ${status === 'active' ? 'btn-danger' : 'btn-success'}`;
                elements.userBlockBtn.dataset.id = userId;
                elements.userBlockBtn.dataset.action = status === 'active' ? 'block' : 'unblock';
                elements.userDeleteBtn.dataset.id = userId;

                getModalInstance(elements.userModalEl)?.show();
            } catch(e) {
                alert(e.message);
            } finally {
                showLoader(false);
            }
        }
        async function openRegisteredPlayersModal(tId, tName) { if(!db) return; getModalInstance(elements.registeredPlayersModalEl)?.show(); elements.registeredPlayersTournamentName.textContent = tName; elements.registeredPlayersTableBody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>'; try { const snap = await get(ref(db, `tournaments/${tId}/registeredPlayers`)); let html = ''; if(snap.exists()){ for(const uid in snap.val()){ const uSnap = await get(ref(db, `users/${uid}`)); const u = uSnap.exists() ? uSnap.val() : {displayName: 'N/A', email: 'N/A'}; html += `<tr><td>${uid}</td><td>${u.displayName}</td><td>${u.email}</td><td>${formatDate(snap.val()[uid].joinedAt)}</td></tr>`; } } elements.registeredPlayersTableBody.innerHTML = html || '<tr><td colspan="4">No players.</td></tr>'; } catch(e) { elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="4">Error: ${e.message}</td></tr>`; } }
        
        function openEpisodesListModal(movieId) {
            const movie = moviesDataCache[movieId];
            if (!movie) return;

            elements.episodesListMovieName.textContent = movie.name;
            const accordionContainer = elements.episodesListAccordion;
            accordionContainer.innerHTML = '';

            if (movie.seasons && Object.keys(movie.seasons).length > 0) {
                let accordionHtml = '';
                Object.entries(movie.seasons).forEach(([seasonTitle, seasonData], index) => {
                    const seasonId = `season-list-${movieId}-${index}`;
                    let episodesHtml = '<ul class="list-group list-group-flush">';
                    if (seasonData.episodes && Object.keys(seasonData.episodes).length > 0) {
                        Object.values(seasonData.episodes).forEach(ep => {
                            episodesHtml += `
                                <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center">
                                    <div>${sanitizeHTML(ep.title)} <span class="badge bg-info">${sanitizeHTML(ep.quality)}</span></div>
                                    <div class="action-buttons">
                                        <a href="${sanitizeHTML(ep.playUrl)}" target="_blank" class="btn btn-sm btn-primary"><i class="bi bi-play-fill"></i> Play</a>
                                        <a href="${sanitizeHTML(ep.downloadUrl)}" target="_blank" class="btn btn-sm btn-success"><i class="bi bi-download"></i> Download</a>
                                    </div>
                                </li>`;
                        });
                    } else {
                        episodesHtml += '<li class="list-group-item bg-transparent">No episodes found for this season.</li>';
                    }
                    episodesHtml += '</ul>';

                    accordionHtml += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-${seasonId}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${seasonId}" aria-expanded="false" aria-controls="collapse-${seasonId}">
                                    ${sanitizeHTML(seasonTitle)}
                                </button>
                            </h2>
                            <div id="collapse-${seasonId}" class="accordion-collapse collapse" aria-labelledby="heading-${seasonId}">
                                <div class="accordion-body p-0">${episodesHtml}</div>
                            </div>
                        </div>`;
                });
                accordionContainer.innerHTML = accordionHtml;
            } else {
                accordionContainer.innerHTML = '<div class="text-center p-3 text-muted">No seasons or episodes found for this movie.</div>';
            }
            getModalInstance(elements.episodesListModalEl)?.show();
        }

        function handleTimeAdjustButtons(event) {
            const button = event.target.closest('button[data-time-adjust]'); if (!button) return;
            const input = elements.tournamentStartTimeInput;
            let date = input.value ? new Date(input.value) : new Date();
            const action = button.dataset.timeAdjust;
            if(action === 'now') date = new Date();
            else if(action === 'add'){
                const unit = button.dataset.unit, amount = parseInt(button.dataset.amount);
                if(unit === 'hours') date.setHours(date.getHours() + amount);
                else if(unit === 'days') date.setDate(date.getDate() + amount);
                else if(unit === 'weeks') date.setDate(date.getDate() + (amount * 7));
            }
            input.value = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        }

        // --- Demo Data ---
        async function addDemoData() {
            if (!db || !confirm("This will add sample data only if a section is empty. Continue?")) return;
            showLoader(true);
            try {
                let addedCount = 0;
                const gamesSnap = await get(ref(db, 'games'));
                if (!gamesSnap.exists()) {
                    const demoGames = {
                        "game1": { name: "Action Hero", imageUrl: "https://i.ibb.co/3kCj5fV/action.jpg" },
                        "game2": { name: "Strategy Master", imageUrl: "https://i.ibb.co/3kCj5fV/action.jpg" }
                    };
                    await set(ref(db, 'games'), demoGames);
                    addedCount++;
                }

                 const categoriesSnap = await get(ref(db, 'movieCategories'));
                 if (!categoriesSnap.exists()) {
                    await set(ref(db, 'movieCategories'), {
                        "cat1": {name: "Sci-Fi", imageUrl: "https://i.ibb.co/3kCj5fV/action.jpg"},
                        "cat2": {name: "Mystery", imageUrl: "https://i.ibb.co/3kCj5fV/action.jpg"}
                    });
                 }

                const moviesSnap = await get(ref(db, 'movies'));
                if (!moviesSnap.exists()) {
                    const demoMovies = {
                        "movie1": { name: "The Galactic Core", imageUrl: "https://i.ibb.co/3kCj5fV/action.jpg", releaseDate: "2023-05-15", tags: ["Sci-Fi", "Adventure"], categoryId: "cat1", 
                            seasons: {
                                "Season 1": { episodes: { "ep1": {title: "The Awakening", quality: "1080p", playUrl: "#", downloadUrl: "#"}, "ep2": {title: "First Contact", quality: "1080p", playUrl: "#", downloadUrl: "#"} } }
                            }
                        },
                        "movie2": { name: "Mystery of the Old Manor", imageUrl: "https://i.ibb.co/3kCj5fV/action.jpg", releaseDate: "2022-10-31", tags: ["Mystery", "Thriller"], categoryId: "cat2" }
                    };
                    await set(ref(db, 'movies'), demoMovies);
                    addedCount++;
                }
                
                alert("Demo data check complete. " + (addedCount > 0 ? "Added some sample data." : "Database was not empty."));
                window.location.reload();
            } catch (error) {
                alert("Error adding demo data: " + error.message);
            } finally {
                showLoader(false);
            }
        }


        // --- Main Event Listener Initialization ---
        function initializeAdminEventListeners() {
            if (!auth || !db) return;
            // Auth & Nav
            elements.adminSetupForm?.addEventListener('submit', setupAdmin);
            elements.adminLoginForm?.addEventListener('submit', loginAdmin);
            elements.adminLogoutBtn?.addEventListener('click', logoutAdminUser);
            elements.sidebarLinks?.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); showAdminSection(link.dataset.section); }); });
            // Saves
            elements.saveGameBtn?.addEventListener('click', saveGame);
            elements.saveMovieBtn?.addEventListener('click', saveMovie);
            elements.saveMovieCategoryBtn?.addEventListener('click', saveMovieCategory);
            elements.savePromotionBtn?.addEventListener('click', savePromotion);
            elements.saveMoviePromotionBtn?.addEventListener('click', saveMoviePromotion);
            elements.saveNewUserBtn?.addEventListener('click', saveNewUser);
            elements.saveReplyBtn?.addEventListener('click', saveReply);
            elements.tournamentForm?.addEventListener('submit', saveTournament);
            elements.appSettingsForm?.addEventListener('submit', saveSettings);
            elements.updateBalanceForm?.addEventListener('submit', updateUserBalance);
            elements.changePasswordForm?.addEventListener('submit', changeAdminPassword);
            elements.sendNotificationBtnModal?.addEventListener('click', sendNotification);
            // Modal Triggers & Actions
            elements.addNewGameBtn?.addEventListener('click', () => { elements.gameForm.reset(); elements.gameEditId.value = ''; elements.gameModalTitle.textContent = "Add New Game"; });
            elements.addNewMovieBtn?.addEventListener('click', () => { elements.movieForm.reset(); elements.seasonsContainer.innerHTML = ''; elements.movieEditId.value = ''; elements.movieModalTitle.textContent = "Add New Movie"; populateMovieCategorySelect(); addSeason(); });
            elements.addNewMovieCategoryBtn?.addEventListener('click', () => { elements.movieCategoryForm.reset(); elements.movieCategoryEditId.value = ''; elements.movieCategoryModalTitle.textContent = "Add New Movie Category"; });
            elements.addNewPromotionBtn?.addEventListener('click', () => { elements.promotionForm.reset(); elements.promotionEditId.value = ''; elements.promotionModalTitle.textContent = "Add New App Promotion"; });
            elements.addNewMoviePromotionBtn?.addEventListener('click', () => { elements.moviePromotionForm.reset(); elements.moviePromotionEditId.value = ''; elements.moviePromotionModalTitle.textContent = "Add New Movie Promotion"; });
            elements.addNewTournamentBtn?.addEventListener('click', () => { currentEditingTournamentId = null; elements.tournamentForm.reset(); populateGameSelect(); });
            elements.userBlockBtn?.addEventListener('click', toggleUserBlock);
            elements.userDeleteBtn?.addEventListener('click', (e) => { const btn = e.target.closest('button'); if(btn) deleteUser(btn.dataset.id); });
            elements.approveWithdrawalBtn?.addEventListener('click', processWithdrawalAction);
            elements.rejectWithdrawalBtn?.addEventListener('click', processWithdrawalAction);
            elements.addTournamentModalEl?.addEventListener('click', handleTimeAdjustButtons);
            elements.addDemoDataBtn?.addEventListener('click', addDemoData);
            elements.addSeasonBtn?.addEventListener('click', addSeason);
            // Search
            elements.userSearchInput?.addEventListener('input', () => {
                const searchTerm = elements.userSearchInput.value.toLowerCase();
                const filteredUsers = Object.values(fullUserDataCache).filter(u => 
                    u.displayName?.toLowerCase().includes(searchTerm) || 
                    u.email?.toLowerCase().includes(searchTerm)
                );
                renderUsersTable(filteredUsers);
            });
            elements.transactionSearchInput?.addEventListener('input', () => {
                const searchTerm = elements.transactionSearchInput.value.toLowerCase();
                const filtered = allTransactionsCache.filter(tx => 
                    JSON.stringify(tx).toLowerCase().includes(searchTerm)
                );
                renderTransactionsTable(filtered);
            });
            // Theme
            elements.saveThemeBtn?.addEventListener('click', saveTheme);
            elements.resetThemeBtn?.addEventListener('click', resetTheme);
            elements.customThemeForm?.addEventListener('input', (e) => { if(e.target.type === 'color') e.target.nextElementSibling.value = e.target.value; else if(e.target.type === 'text') getElement(e.target.dataset.target).value = e.target.value; });
            ['previewDefaultThemeBtn','previewCrimsonThemeBtn','previewOceanicThemeBtn'].forEach(id => { getElement(id)?.addEventListener('click', () => populateThemePickers(id.includes('Crimson') ? crimsonTheme : id.includes('Oceanic') ? oceanicTheme : defaultTheme)); });
            // Delegated listener for tables
            document.body.addEventListener('click', (event) => {
                 const target = event.target.closest('button[data-id], button[data-comment-id], button[data-reply-id], .copy-btn'); if (!target) return;
                 if(target.classList.contains('copy-btn')) { copyToClipboard(target.dataset.target); return; }
                 const id = target.dataset.id;
                 if (target.classList.contains('btn-delete-game')) deleteGame(id);
                 else if (target.classList.contains('btn-edit-game')) { openEditGameModal(id) }
                 else if (target.classList.contains('btn-delete-movie')) deleteMovie(id);
                 else if (target.classList.contains('btn-edit-movie')) openEditMovieModal(id);
                 else if (target.classList.contains('btn-view-episodes')) openEpisodesListModal(id);
                 else if (target.classList.contains('btn-delete-movie-category')) deleteMovieCategory(id);
                 else if (target.classList.contains('btn-edit-movie-category')) openEditMovieCategoryModal(id);
                 else if (target.classList.contains('btn-delete-review')) {
                    const { movieId, episodeId, commentId } = target.dataset;
                    deleteMovieReview(movieId, episodeId, commentId);
                 }
                 else if (target.classList.contains('btn-pin-comment')) {
                    const { movieId, episodeId, commentId, pinned } = target.dataset;
                    togglePinComment(movieId, episodeId, commentId, pinned === 'true');
                 }
                 else if (target.classList.contains('btn-reply-comment')) {
                    const { movieId, episodeId, commentId } = target.dataset;
                    openReplyModal(movieId, episodeId, commentId);
                 }
                 else if (target.classList.contains('btn-delete-reply')) {
                    const { movieId, episodeId, commentId, replyId } = target.dataset;
                    deleteReply(movieId, episodeId, commentId, replyId);
                 }
                 else if (target.classList.contains('btn-delete-promo')) deletePromotion(id);
                 else if (target.classList.contains('btn-edit-promo')) openEditPromotionModal(id);
                 else if (target.classList.contains('btn-delete-movie-promo')) deleteMoviePromotion(id);
                 else if (target.classList.contains('btn-edit-movie-promo')) openEditMoviePromotionModal(id);
                 else if (target.classList.contains('btn-delete-tournament')) deleteTournament(id);
                 else if (target.classList.contains('btn-edit-tournament')) openEditTournamentModal(id);
                 else if (target.classList.contains('btn-view-user')) openUserModal(id);
                 else if (target.classList.contains('btn-approve-withdrawal')) openWithdrawalActionModal(id, 'approve');
                 else if (target.classList.contains('btn-reject-withdrawal')) openWithdrawalActionModal(id, 'reject');
                 else if (target.classList.contains('btn-delete-user')) deleteUser(id);
                 else if (target.classList.contains('btn-view-registered')) openRegisteredPlayersModal(id, target.dataset.name);
                 else if (target.classList.contains('btn-delete-notification')) deleteNotification(id);
            });
            elements.notificationAudienceSelect?.addEventListener('change', (e) => {
                elements.notificationSpecificUserDiv.style.display = e.target.value === 'specific' ? 'block' : 'none';
            });
        }
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!app || !auth || !db) return;
            initializeAdminEventListeners();
            onAuthStateChanged(auth, handleAdminAuthStateChange);
        });
    </script>
</body>
</html>